<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>百川智慧媒合系統 (Puter.js 整合修正版)</title>
    <script src="https://js.puter.com/v2/"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar-hide utility */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        body {
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- 資料庫: 根據您提供的所有學長姐資料擴充而成 ---
        const mentorsData = [
         // AI & Data Science
         { id: "111950005", name: "黃宇晨", title: "Generative Adversarial Networks (GAN)", summary: "本專題旨在透過拍攝科普影片介紹「生成對抗網路」（GAN）的原理與應用，並研究Midjourney、Stable Diffusion等AI圖像生成技術。", keywords: ["GAN", "深度學習", "AI圖像生成", "Stable Diffusion", "Midjourney", "科普影片", "擴增實境", "AR", "Unity"] },
         { id: "111950031", name: "陳妍沂", title: "Analysis of Go Player with EEG-based BCI & Reinforcement Learning", summary: "此專題包含兩部分：一是介紹腦機介面(BCI)並分析圍棋棋手的腦波活動；二是應用強化學習（Reinforcement Learning）技術訓練AI遊玩益智遊戲「2048」。", keywords: ["Brain-Computer Interface", "BCI", "EEG", "腦波", "reinforcement learning", "2048", "AI", "machine learning"] },
         { id: "111950019", name: "張沂竣", title: "Supervised Machine Learning Method for Predicting Supermarket Item Prices", summary: "This study performs a regression analysis using supervised machine learning to predict the prices of various supermarket items. Several algorithms were tested, including Linear, Lasso, Ridge regression, and XGBoost.", keywords: ["machine learning", "regression", "price prediction", "XGBoost", "feature engineering", "Python", "scikit-learn"] },
         { id: "110950011", name: "廖家淯", title: "自動辨識學校別名的演算法設計", summary: "本專題設計了一套能自動辨識大學別名的演算法。演算法採用TF-IDF技術將詞語轉換為數值向量，並計算餘弦相似度來找出最相符的結果。", keywords: ["別名辨識", "演算法", "TF-IDF", "向量化", "餘弦相似度", "自然語言處理", "NLP"] },
         { id: "112950026", name: "孫奇霆", title: "基於文字描述的通用圖像編輯層之生成", summary: "本研究旨在解決現有文字生成圖片模型無法對給定圖片進行局部修改的問題。研究提出一個模型，能根據輸入的一張圖片和一段文字描述，生成一個透明的RGBA編輯層，實現語義化、局部的修改效果。", keywords: ["圖像編輯", "生成模型", "CLIP", "U-Net", "零樣本學習", "AI"] },

         // Hardware & Engineering
         { id: "110263008", name: "蔡秀吉", title: "O-RAN可程式化自動流量引導xApp之開發", summary: "本專題旨在開發O-RAN（開放式無線接取網路）架構下的流量引導（Traffic Steering, TS）xApp應用程式，以優化特定用戶的通訊品質。", keywords: ["O-RAN", "Traffic Steering", "xApp", "5G", "網路優化", "學生治理"] },
         { id: "111950023", name: "吳佳芸", title: "智慧穿戴裝置元件 & Multi-Frequency Antenna", summary: "此系列研究包含拆解與分析智慧穿戴裝置的內部元件（以GARMIN fēnix 5X Plus為例），以及設計與模擬一款能在7GHz、17GHz和32.5GHz三個頻率下共振的多頻段天線。", keywords: ["智慧穿戴裝置", "GARMIN", "GPS", "NFC", "天線設計", "HFSS", "RF"] },
         { id: "110950027", name: "王冠樺", title: "智慧魚缸的探討及實作", summary: "本專題旨在探討並實作一個智慧魚缸系統，以ESP32為核心，整合自動餵食、水質過濾及溫度控制等功能，並具備遠端監控能力。", keywords: ["智慧魚缸", "ESP32", "物聯網", "IoT", "自動化控制"] },
         { id: "110950002", name: "邱于瑄", title: "穿戴式定位裝置開發", summary: "本研究旨在開發一款以藍牙技術為基礎的穿戴式追蹤裝置，可用於尋找遺失物品或需關懷的親人。研究方法初期透過對Apple Airtag的逆向工程來建立雛形。", keywords: ["穿戴式裝置", "定位裝置", "藍牙", "BLE", "Airtag", "逆向工程", "nRF52840"] },
         { id: "113950027", name: "江采霓", title: "Modeling of a Piezoelectric-Based Intelligent Seismic Isolation System", summary: "鑒於台灣頻繁的地震活動，本研究旨在開發一套基於壓電材料的智慧型隔震系統（PSIS）。利用LSTM與深度強化學習（DRL）訓練控制模組，實現快速精準的減災目標。", keywords: ["seismic isolation", "piezoelectric", "deep reinforcement learning", "earthquake engineering", "土木工程", "LSTM", "DRL"] },
         { id: "1112950008", name: "吳懿恩", title: "Optimized Single-Layer MoSe2 Epitaxy and Mobility", summary: "本研究旨在優化化學氣相沉積法(CVD)的生長參數，以合成高品質且穩定的單層二硒化鉬(MoSe2)薄膜，並探討其作為半導體通道材料的應用潛力。", keywords: ["MoSe2", "CVD", "monolayer", "半導體", "FET", "carrier mobility", "材料科學"] },

         // Business & Entrepreneurship
         { id: "110950004", name: "朱立恆", title: "大學生創投家? 青年創投訓練班實作", summary: "本專題旨在探討創投人才是否可被培育，並記錄了一個為期六週的「青年創投訓練班」的實作過程。課程內容依循創投的「募、投、管、退」流程設計。", keywords: ["創業投資", "VC", "人才培育", "課程設計", "Kirkpatrick模型", "新創"] },
         { id: "112950022", name: "洪宇辰", title: "擺脫對 GPT 的依賴-AI陪跑人生", summary: "本專題基於創業經歷，開發了一款強調「陪跑」概念的AI產品，定位為能與用戶共同設計人生戰略的生涯諮詢師。", keywords: ["AI", "AI Agent", "生涯諮詢", "創業", "個人化學習", "GPT"] },
         { id: "112950013", name: "陳大森", title: "台灣咖啡廳創業經營現況與未來趨勢探索", summary: "本研究旨在探討台灣獨立咖啡廳的創業現況，分析其啟動資金、回本預期、收益空間及經營風險。", keywords: ["獨立咖啡廳", "創業", "經營現況", "商業模式", "SWOT", "生技保健食品"] },
         { id: "111481049", name: "陳可婕", title: "AI PC產業分析——————以華碩為例", summary: "本研究針對興起的AI PC產業進行分析，並以華碩(ASUS)為個案研究對象。運用五力分析模型評估產業結構，並提出策略建議。", keywords: ["AI PC", "產業分析", "五力分析", "華碩", "ASUS", "生態系", "市場策略"] },
         { id: "110481016", name: "劉星妤", title: "燃油機車市場的競爭策略分析 --以三陽跟光陽為例", summary: "本研究旨在深入分析台灣兩大燃油機車品牌——三陽（Sym）與光陽（Kymco）的市場競爭策略。研究追蹤了市佔率變化並運用SWOT分析工具檢視其策略。", keywords: ["三陽", "光陽", "機車市場", "市佔率", "競爭策略", "SWOT分析"] },

         // Arts, Design & Culture
         { id: "111950006", name: "洪琳玲", title: "同步物件：看見人物肢體外的舞蹈理念與編舞結構的翻譯", summary: "本研究旨在分析舞蹈家William Forsythe的作品，透過擷取舞蹈中的特定資訊，並以20種不同的視覺化方式重新呈現，藉此翻譯並揭示其編舞結構。", keywords: ["編舞結構", "視覺化", "William Forsythe", "舞蹈與科技", "街舞教學", "兒童教育"] },
         { id: "110950024", name: "楊芷嫺", title: "嚴肅主題的遊戲化設計研究——以互動敘事遊戲 \"Tell Me Why\"為例", summary: "本研究旨在探討如何有效地將嚴肅主題（如教育、政治、醫療等）進行「遊戲化」設計。研究以互動敘事遊戲《Tell Me Why》為案例，運用設計思考工具收集玩家回饋。", keywords: ["嚴肅遊戲", "遊戲化", "互動敘事", "Tell Me Why", "設計思考", "共同設計"] },
         { id: "111950010", name: "雷翔茲", title: "從故事行銷與敘事手法分析居家用品廣告—以IKEA近五年的廣告為例", summary: "本研究旨在分析IKEA近五年來的廣告，探討其如何運用故事行銷與敘事手法來進行傳播，並結合傳播理論（如SMCRE模型）進行剖析。", keywords: ["故事行銷", "敘事手法", "IKEA", "廣告分析", "傳播SMCRE", "Martech"] },
         { id: "110950017", name: "張念晴", title: "管弦樂曲創作：譜寫台灣的百年追求（百年追求一序曲：輪迴）", summary: "本專題為一首原創管弦樂曲《百年追求—序曲：輪迴》的創作成果。此樂曲旨在描繪福爾摩沙（台灣）及其人民追求自由的故事。", keywords: ["管弦樂", "音樂創作", "台灣", "福爾摩摩沙", "歷史", "藝術創作"] },
         { id: "112950017", name: "張廷安", title: "Procreate 電繪訓練", summary: "本專題旨在透過使用Procreate軟體，訓練學生的數位繪圖技巧。訓練內容涵蓋人物插畫、建築透視以及排版設計等多個面向。", keywords: ["Procreate", "電繪", "數位藝術", "插畫", "平面設計"] },
         { id: "112950018", name: "蔡承珉", title: "網頁動畫與 Shader 應用研究", summary: "本專題研究網頁動畫與Shader的應用，並透過實作一個互動式網頁來展示成果。專題利用GLSL（OpenGL Shading Language）編寫程式碼，實現互動視覺效果。", keywords: ["Shader", "網頁動畫", "WebGL", "Vertex Shader", "Fragment Shader", "GLSL", "前端開發"] },
         { id: "111950002", name: "林韋婷", title: "虛擬世界--瘋狂XR", summary: "本專題旨在探討XR（擴展實境）的概念，並透過專案製作與demo統整來進行實踐，分析成功的VR體驗應具備「完整度」與「VR特性」兩大要素。", keywords: ["XR", "VR", "AR", "MR", "虛擬實境", "遊戲設計"] },

         // Social Sciences & Humanities
         { id: "111950024", name: "林子婕", title: "高中生與大學生階段使用Instagram社群媒體產生之心理影響發展對比", summary: "本研究旨在探討並比較青少年在高中與大學兩個不同階段，因使用社群媒體Instagram所造成的心理層面影響與變化。", keywords: ["Instagram", "社交媒體", "心理影響", "社交焦慮", "青少年", "問卷調查"] },
         { id: "111950008", name: "卓予杰", title: "性侵性騷擾：其創傷中的社會建構性", summary: "本研究旨在探討性侵害與性騷擾事件中所產生的創傷，有多少成分是受到社會建構的影響。研究方法為深度訪談。", keywords: ["性侵", "性騷擾", "創傷", "社會建構", "性別", "深度訪談"] },
         { id: "110950001", name: "林芷樂", title: "The Imposter Phenomenon - Elucidating Effectors & Model Construction", summary: "本研究旨在透過量化方法探討台灣大學生中的冒名頂替現象（Imposter Phenomenon, IP）。研究假設低自尊會透過「向上社會比較」，間接預測較高的冒名頂頂替感。", keywords: ["Imposter Phenomenon", "IP", "self-esteem", "social comparison", "quantitative study", "心理學"] },
         { id: "109950017", name: "汪李芊", title: "我們擁有相同的歷史記憶嗎？聽老人說話", summary: "本研究旨在紀錄台東卡大地布（Katratripulr）部落耆老的口述地方故事，探討在宏觀歷史脈絡下，部落族人如何應對過去的殖民政策。", keywords: ["口述歷史", "原住民歷史", "卡大地布部落", "卑南族", "地方史", "田野調查"] },
         { id: "112950030", name: "吉芸箴", title: "死刑爭議之我見", summary: "本專題探討台灣的死刑爭議，並聚焦於憲法法庭113年憲判字第8號的判決，並從加害者與被害者雙方觀點出發，提出個人看法。", keywords: ["死刑", "憲法", "生命權", "人權", "司法", "法律"] },

         // Physics, Chemistry & Medical Science
         { id: "111950015", name: "高家恩", title: "Noether's theorem之推導及對場概念的熟悉", summary: "本報告旨在推導並闡釋諾特定理（Noether's theorem），該定理闡述了物理系統中的對稱性與守恆量之間的深刻聯繫。", keywords: ["Noether's theorem", "諾特定理", "變分法", "歐拉-拉格朗日方程", "物理", "Raman spectroscopy", "Wagyu beef"] },
         { id: "111950032", name: "張仁瑀", title: "量子隨機行走模擬化學碰撞電子軌域分配問題", summary: "本研究旨在運用量子隨機行走（Quantum Random Walk）模型來模擬化學反應中的產率問題，以提供一個更接近量子力學本質的解釋。", keywords: ["量子隨機行走", "化學碰撞", "產率預測", "量子計算", "量子電腦", "QRACON"] },
         { id: "Novel miRNA-based multi-state model", name: "何彥霖", title: "Novel miRNA-based multi-state model for predicting recurrence and survival of patients with lung cancer", summary: "This study proposes a novel multi-state model based on microRNAs (miRNAs) to simultaneously predict the personal transition probabilities of recurrence and death in lung cancer patients.", keywords: ["lung cancer", "miRNA", "multi-state model", "biomarkers", "survival prediction", "TCGA", "醫學", "統計"] },
         { id: "112950016", name: "施羽庭", title: "Comparative Efficacy of rTMS, tDCS and TBS Across Neurological and Psychiatric Disorders", summary: "本研究旨在透過系統性文獻回顧，評估與比較三種常見的非侵入性腦刺激技術：rTMS、tDCS與TBS，在多種神經及精神疾病上的治療效果。", keywords: ["rTMS", "tDCS", "TBS", "systematic review", "neuropsychiatric disorders", "腦科學"] },
        ];

        // --- 手機介面組件 ---
        const StatusBar = () => { /* ... 內容不變 ... */ };
        const GestureBar = () => ( <div className="absolute bottom-2 left-1/2 -translate-x-1/2 w-32 h-1.5 bg-gray-800 rounded-full"></div> );

        // --- App 核心邏輯組件 ---
        const MentorshipApp = () => {
            const [view, setView] = useState('search');
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [selectedMentor, setSelectedMentor] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            const scrollContainerRef = useRef(null);

            const scrollToTop = () => {
                if (scrollContainerRef.current) {
                    scrollContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            // ✅ 修正 1: 改造 AI 核心呼叫函式，使其更穩健
            const callAI = async (prompt) => {
                let delay = 1000;
                for (let i = 0; i < 3; i++) { // 保留重試機制
                    try {
                        const response = await puter.ai.chat(prompt, {
                            model: 'google/gemini-pro',
                            temperature: 0.1 
                        });
                        
                        const rawResponse = response?.message?.content;
                        if (!rawResponse) {
                            throw new Error("AI 回應為空。");
                        }
                        
                        // ✅ 修正 2: 從 AI 的潛在回文中提取純淨的 JSON
                        const jsonMatch = rawResponse.match(/\[[\s\S]*\]|{[\s\S]*}/);
                        if (!jsonMatch) {
                            console.error("在 AI 回應中找不到有效的 JSON 結構:", rawResponse);
                            throw new Error("AI 未回傳可辨識的 JSON 格式。");
                        }
                        
                        const jsonString = jsonMatch[0];
                        return JSON.parse(jsonString); // 解析清潔後的字串
                    
                    } catch (err) {
                        console.error(`AI 呼叫嘗試 ${i + 1} 失敗:`, err);
                        if (i === 2) throw err; // 最後一次嘗試失敗後，拋出錯誤
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
                throw new Error("AI 請求在多次重試後失敗。");
            };

            const handleSearch = async () => {
                if (!query.trim()) return;
                setIsLoading(true);
                setError(null);

                const simplifiedMentors = mentorsData.map(({ id, name, title, keywords, summary }) => ({ id, name, title, keywords, summary }));
                
                const fullPrompt = `你是一位專業的大學學術與職涯導師，你的任務是幫助迷惘的學生找到最適合的學長姐作為 Mentor。
1. 你會收到一段學生的提問，以及一份 JSON 格式的學長姐資料庫。
2. 請仔細分析學生的提問，理解其背後的真正需求，可能包含多個領域或模糊的概念。
3. 根據學生的需求，從資料庫中找出 4 位最相關、最能提供幫助的學長姐。
4. 你的回覆必須是「純粹的、可直接被 JSON.parse() 解析的 JSON 陣列」，不包含任何額外文字或 markdown 符號。
5. 在 'reason' 欄位中，用繁體中文、溫暖且具說服力的語氣，簡要解釋為什麼這位學長姐是個好人選（約 30-50 字）。
6. 在 'fit' 欄位中，給出一個 80 到 100 之間的契合度分數。最符合的應高於 95 分。

這是學長姐資料庫: ${JSON.stringify(simplifiedMentors)}

這是學生的問題: "${query}"

請回傳符合以下結構的 JSON 陣列:
[
  { "id": "學號", "fit": 98, "reason": "推薦原因..." },
  { "id": "學號", "fit": 95, "reason": "推薦原因..." }
]
`;

                try {
                    const aiResults = await callAI(fullPrompt);
                    
                    // ✅ 修正 3: 增加對回傳資料的結構驗證
                    if (!Array.isArray(aiResults)) {
                        console.error("AI 回傳了合法的 JSON，但不是預期的陣列格式:", aiResults);
                        throw new Error("AI 回應的資料結構不符合預期。");
                    }

                    const finalResults = aiResults.map(aiMentor => {
                        const fullMentorData = mentorsData.find(m => m.id === aiMentor.id);
                        return { ...fullMentorData, fit: aiMentor.fit, reason: aiMentor.reason };
                    }).filter(Boolean);
                    
                    setResults(finalResults);
                    setView('results');
                    scrollToTop();
                } catch (err) {
                    console.error("處理 AI 搜尋時發生錯誤:", err);
                    setError("抱歉，AI 智慧檢索暫時無法使用，請稍後再試。");
                } finally {
                    setIsLoading(false);
                }
            };
            
            // --- 其餘的 React 邏輯保持不變 ---
            const handleSuggestionClick = (suggestion) => { /* ... */ };
            const handleSelectMentor = (mentor) => { /* ... */ };
            const resetToSearch = () => { /* ... */ };
            const FitBar = ({ percentage }) => { /* ... */ };

            return (
                <div ref={scrollContainerRef} className="bg-white text-gray-800 h-full w-full overflow-y-auto scrollbar-hide p-4 pt-0">
                    {/* ... JSX 內容完全不變 ... */}
                </div>
            );
        };

        // --- 主應用程式組件 (手機外殼) ---
        function App() {
          return (
            <main className="font-sans bg-slate-100 min-h-screen flex items-center justify-center p-4">
              <div className="relative mx-auto border-gray-800 bg-gray-800 border-[10px] rounded-[2.5rem] h-[800px] w-[380px] shadow-2xl">
                {/* ... 手機外殼 JSX 內容完全不變 ... */}
                <div className="w-full h-full overflow-hidden rounded-[2rem] bg-white">
                  <div className="relative w-full h-full flex flex-col">
                    <StatusBar />
                    <div className="flex-grow relative">
                      <MentorshipApp />
                    </div>
                    <GestureBar />
                  </div>
                </div>
              </div>
            </main>
          );
        }

        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
