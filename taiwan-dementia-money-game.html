<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŒ¢ï¼Œçš„è¶£å‘³</title>
    <!-- å¼•å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts çš„ Noto Sans TC (æ€æºé»‘é«”) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- å…¨åŸŸèˆ‡åŸºæœ¬æ¨£å¼ --- */
        body {
            font-family: 'Noto Sans TC', sans-serif; /* è¨­å®šç¶²ç«™å­—é«” */
            touch-action: manipulation; /* æå‡è¡Œå‹•è£ç½®è§¸æ§é«”é©—ï¼Œé˜²æ­¢é»æ“Šå»¶é² */
            background-color: #f3f4f6; /* è¨­å®šèƒŒæ™¯è‰²ç‚ºæ·ºç°è‰² */
        }

        /* --- æŒ‰éˆ•çµ±ä¸€æ¨£å¼ --- */
        .btn {
            transition: all 0.2s ease; /* æ‰€æœ‰å±¬æ€§è®ŠåŒ–éƒ½æœ‰ 0.2 ç§’çš„éæ¸¡å‹•ç•« */
            font-weight: 700; /* ç²—é«”å­— */
        }

        /* æŒ‰éˆ•è¢«é»æ“Šæ™‚çš„äº’å‹•æ•ˆæœ */
        .btn:active {
            transform: scale(0.97); /* è¼•å¾®ç¸®å°ï¼Œç”¢ç”ŸæŒ‰ä¸‹çš„æ„Ÿè¦º */
        }

        /* æŒ‰éˆ•è¢«ç¦ç”¨æ™‚çš„æ¨£å¼ */
        .btn:disabled {
            opacity: 0.5; /* åŠé€æ˜ */
            cursor: not-allowed; /* æ»‘é¼ æŒ‡æ¨™è®Šç‚ºç¦æ­¢åœ–ç¤º */
        }

        /* --- é¸é …æŒ‰éˆ•çš„å°ˆå±¬æ¨£å¼ --- */
        .option-btn {
            transition: background-color 0.2s ease, transform 0.2s ease; /* æŒ‡å®šéæ¸¡å‹•ç•«çš„å±¬æ€§ */
            border-width: 3px; /* é‚Šæ¡†å¯¬åº¦ */
        }

        /* é¸é …æŒ‰éˆ•è¢«é»æ“Šæ™‚çš„äº’å‹•æ•ˆæœ (åƒ…é™æœªç¦ç”¨æ™‚) */
        .option-btn:not([disabled]):active {
            transform: scale(0.97);
        }

        /* ç­”å°æ™‚çš„æ¨£å¼ */
        .option-btn.correct {
            background-color: #16a34a !important; /* ç¶ è‰²èƒŒæ™¯ */
            color: white !important; /* ç™½è‰²æ–‡å­— */
            border-color: #15803d !important; /* æ·±ç¶ è‰²é‚Šæ¡† */
        }

        /* ç­”éŒ¯æ™‚çš„æ¨£å¼ */
        .option-btn.wrong {
            background-color: #dc2626 !important; /* ç´…è‰²èƒŒæ™¯ */
            color: white !important; /* ç™½è‰²æ–‡å­— */
            border-color: #b91c1c !important; /* æ·±ç´…è‰²é‚Šæ¡† */
        }

        /* --- å‹•ç•«å®šç¾© --- */
        /* æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* å½ˆå‡ºå‹•ç•« */
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .pop-in {
            animation: popIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex items-center justify-center min-h-screen p-4">

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app" class="w-full max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl p-6 md:p-10">

        <!-- 1. é¦–é ç•«é¢ -->
        <div id="home-screen" class="text-center py-12">
            <h1 class="text-6xl md:text-7xl font-bold text-amber-600 mb-12">éŒ¢ï¼Œçš„è¶£å‘³</h1>
            <button id="start-btn" class="btn w-full text-3xl bg-amber-500 hover:bg-amber-600 text-white py-5 px-6 rounded-xl shadow-lg">
                é–‹å§‹éŠæˆ²
            </button>
        </div>

        <!-- 2. é¸æ“‡æ¨¡çµ„ç•«é¢ -->
        <div id="module-selection-screen" class="hidden">
            <h2 class="text-5xl font-bold text-center mb-8">ä»Šå¤©æƒ³èŠä»€éº¼ï¼Ÿ</h2>
            <div class="space-y-5">
                <button data-module="market" class="module-btn btn w-full text-left p-6 bg-green-100 hover:bg-green-200 rounded-xl flex items-center space-x-6 shadow-sm border-2 border-green-200">
                    <span class="text-5xl">ğŸ¥¬</span>
                    <div>
                        <p class="text-3xl font-bold text-green-800">ç†±é¬§èœå¸‚å ´</p>
                        <p class="text-xl text-gray-600">çŒœçŒœç¾åœ¨çš„èœåƒ¹ã€è‚‰åƒ¹ã€‚</p>
                    </div>
                </button>
                <button data-module="food" class="module-btn btn w-full text-left p-6 bg-red-100 hover:bg-red-200 rounded-xl flex items-center space-x-6 shadow-sm border-2 border-red-200">
                    <span class="text-5xl">ğŸœ</span>
                    <div>
                        <p class="text-3xl font-bold text-red-800">å»Ÿå£å°åƒæ”¤</p>
                        <p class="text-xl text-gray-600">èšµä»”éºµç·šã€è‡­è±†è…ï¼Œæƒ³åƒä»€éº¼ï¼Ÿ</p>
                    </div>
                </button>
                 <button data-module="nostalgia" class="module-btn btn w-full text-left p-6 bg-yellow-100 hover:bg-yellow-200 rounded-xl flex items-center space-x-6 shadow-sm border-2 border-yellow-200">
                    <span class="text-5xl">ğŸ¬</span>
                    <div>
                        <p class="text-3xl font-bold text-yellow-800">æ‡·èˆŠæŸ‘ä»”åº—</p>
                        <p class="text-xl text-gray-600">å›å‘³æ°‘åœ‹ä¸ƒåå¹´ä»£çš„æ»‹å‘³ï¼</p>
                    </div>
                </button>
                <button data-module="home" class="module-btn btn w-full text-left p-6 bg-blue-100 hover:bg-blue-200 rounded-xl flex items-center space-x-6 shadow-sm border-2 border-blue-200">
                    <span class="text-5xl">ğŸ </span>
                    <div>
                        <p class="text-3xl font-bold text-blue-800">ç”Ÿæ´»å¤§å°äº‹</p>
                        <p class="text-xl text-gray-600">ç¹³æ°´é›»è²»ã€çœ‹é›»å½±ã€åŒ…ç´…åŒ…ï¼</p>
                    </div>
                </button>
                 <button data-module="old_money" class="module-btn btn w-full text-left p-6 bg-purple-100 hover:bg-purple-200 rounded-xl flex items-center space-x-6 shadow-sm border-2 border-purple-200">
                    <span class="text-5xl">ğŸª™</span>
                    <div>
                        <p class="text-3xl font-bold text-purple-800">èˆŠæ™‚å…‰çš„è–ªæ°´è¢‹</p>
                        <p class="text-xl text-gray-600">èŠèŠä»¥å‰çš„è–ªæ°´å’Œå¿«æ¨‚æ™‚å…‰ã€‚</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- 3. å•ç­”ç•«é¢ (é¸æ“‡é¡Œ) -->
        <div id="quiz-screen" class="hidden">
            <h2 id="quiz-module-title" class="text-4xl font-bold text-center mb-1 text-gray-600"></h2>
            <p id="quiz-progress-text" class="text-xl text-center text-gray-500 mb-6"></p>
            
            <div class="text-center p-6 bg-gray-50 rounded-xl mb-6 border">
                <img id="quiz-item-image" src="" class="w-full max-w-sm mx-auto rounded-lg mb-4 shadow-md" alt="é¡Œç›®åœ–ç‰‡">
                <p id="quiz-item-name" class="text-4xl font-bold"></p>
                <p id="quiz-item-desc" class="text-xl text-gray-600 mt-2"></p>
            </div>
            
            <div id="options-area">
                <p class="text-2xl text-center text-gray-800 mb-4">è«‹çŒœçŒœçœ‹ï¼Œä¸‹é¢å“ªä¸€å€‹åƒ¹æ ¼æ¯”è¼ƒæ¥è¿‘ï¼Ÿ</p>
                <div id="price-options" class="grid grid-cols-2 gap-4"></div>
            </div>

            <div id="result-area" class="hidden text-center mt-6 p-6 rounded-xl">
                <p id="result-text" class="text-4xl font-bold mb-3"></p>
                <p id="explanation-text" class="text-2xl text-gray-800 mb-6"></p>
                <button id="next-question-btn" class="btn bg-amber-500 hover:bg-amber-600 text-white text-2xl py-4 px-8 rounded-lg shadow-md">ä¸‹ä¸€é¡Œ</button>
            </div>
            
            <button id="back-to-menu-quiz-btn" class="btn w-full mt-8 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-4 rounded-lg">è¿”å›ä¸»é¸å–®</button>
        </div>

        <!-- 4. æ•…äº‹ç•«é¢ (å¼•å°å¼å•ç­”) -->
        <div id="story-screen" class="hidden">
            <h2 id="story-module-title" class="text-4xl font-bold text-center mb-6 text-gray-600"></h2>
             <div class="text-center p-6 bg-gray-50 rounded-xl mb-6 border">
                <img id="story-item-image" src="" class="w-full max-w-md mx-auto rounded-lg mb-4 shadow-md" alt="æ•…äº‹åœ–ç‰‡">
                <p id="story-item-name" class="text-4xl font-bold"></p>
                <p id="story-item-desc" class="text-xl text-gray-600 mt-2"></p>
            </div>
            <button id="next-story-btn" class="btn bg-purple-500 hover:bg-purple-600 text-white text-2xl w-full py-4 px-8 rounded-lg shadow-md">ä¸‹ä¸€é </button>
            <button id="back-to-menu-story-btn" class="btn w-full mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-4 rounded-lg">è¿”å›ä¸»é¸å–®</button>
        </div>
        
        <!-- 5. çµæŸç•«é¢ -->
        <div id="end-screen" class="hidden text-center py-12">
            <h1 class="text-6xl font-bold text-purple-600 mb-6">æ„Ÿè¬å¤§å®¶çš„åƒèˆ‡ï¼</h1>
            <p class="text-3xl text-gray-700 mb-12">å¸Œæœ›æ‚¨ä»Šå¤©éƒ½æœ‰é–‹å¿ƒï¼</p>
            <!-- ã€å·²ç§»é™¤ã€‘é€™è£¡åŸæœ¬çš„çµæŸåœ–ç‰‡å·²è¢«ç§»é™¤ -->
            <button id="restart-btn" class="btn w-full text-3xl bg-amber-500 hover:bg-amber-600 text-white py-5 px-6 rounded-xl shadow-lg">
                é‡æ–°é–‹å§‹
            </button>
        </div>

    </div>

    <script>
        // --- è³‡æ–™åº« ---
        // ã€é—œéµä¿®æ­£ã€‘å°‡åœ–ç‰‡çš„åŸºç¤è·¯å¾‘æ›´æ–°ç‚ºæ‚¨æä¾›çš„ GitHub repo è·¯å¾‘
        const image_base_url = "https://raw.githubusercontent.com/thc1006/taiwan-dementia-money-game/main/images/";
        
        const database = {
            market: { 
                name: "ç†±é¬§èœå¸‚å ´", 
                items: [
                    { name: "ç©ºå¿ƒèœ", price: 30, image: image_base_url + "ç©ºå¿ƒèœ.jpg", desc: "ç¾åœ¨å¸‚å ´é’èœä¸€æŠŠå·®ä¸å¤šé€™å€‹åƒ¹éŒ¢ã€‚" },
                    { name: "è±¬è‚‰ (ä¸€å°æ–¤)", price: 160, image: image_base_url + "è±¬è‚‰ (ä¸€å°æ–¤).jpg", desc: "ç¾åœ¨çš„è±¬è‚‰è¶Šä¾†è¶Šè²´å›‰ï¼" },
                    { name: "è™±ç›®é­š", price: 90, image: image_base_url + "è™±ç›®é­š.jpg", desc: "ç…®æ¹¯ã€ä¹¾ç…éƒ½å¾ˆå¥½åƒï¼" },
                    { name: "é›è›‹ (ä¸€ç›’10ç²’)", price: 65, image: image_base_url + "ä¸€ç›’é›è›‹.jpg", desc: "ç¾åœ¨é›è›‹ä¸ä¾¿å®œï¼Œä»¥å‰ä¸€é¡†æ‰å¹¾è§’éŠ€ã€‚" },
                    { name: "è±†è… (ä¸€å¡Š)", price: 15, image: image_base_url + "è±†è… (ä¸€å¡Š).jpg", desc: "ä¾¿å®œåˆç‡Ÿé¤Šçš„å¥½æ±è¥¿ã€‚" }
                ] 
            },
            food: { 
                name: "å»Ÿå£å°åƒæ”¤", 
                items: [
                    { name: "èšµä»”éºµç·š (å¤§ç¢—)", price: 70, image: image_base_url + "èšµä»”éºµç·š.jpg", desc: "ä»¥å‰ä¸€ç¢—åªè¦åå¹¾å¡ŠéŒ¢å‘¢ï¼" },
                    { name: "è‡­è±†è… (ä¸€ä»½)", price: 60, image: image_base_url + "è‡­è±†è….jpg", desc: "é…ä¸Šæ³¡èœï¼ŒçœŸæ˜¯äººé–“ç¾å‘³ã€‚" },
                    { name: "è‚‰åœ“", price: 45, image: image_base_url + "è‚‰åœ“.jpg", desc: "æ¸…è’¸çš„ã€æ²¹ç‚¸çš„ï¼Œéƒ½å¾ˆå¥½åƒã€‚" },
                    { name: "å¤§è…¸åŒ…å°è…¸", price: 65, image: image_base_url + "å¤§è…¸åŒ…å°è…¸.jpg", desc: "å¤œå¸‚çš„ä»£è¡¨å°åƒä¹‹ä¸€ã€‚" },
                    { name: "å±±æ±å¤§é¥…é ­", price: 25, image: image_base_url + "å±±æ±å¤§é¥…é ­.jpg", desc: "åˆå¤§åˆç´®å¯¦ï¼Œåƒä¸€é¡†å°±å¾ˆé£½ï¼" },
                    { name: "é‹ç›”", price: 50, image: image_base_url + "é‹ç›”.jpg", desc: "çƒ¤å¾—é…¥é…¥è„†è„†çš„ï¼Œåƒå¤§é¤…ä¸€æ¨£ã€‚" },
                    { name: "æ°´é¤ƒ (10é¡†)", price: 70, image: image_base_url + "æ°´é¤ƒ (10é¡†).jpg", desc: "é«˜éº—èœè±¬è‚‰é¤¡ï¼Œæ²¾é†¬æ²¹æœ€å¥½åƒã€‚" }
                ] 
            },
            nostalgia: { 
                name: "æ‡·èˆŠæŸ‘ä»”åº—", 
                items: [
                    { name: "ç‹å­éºµ", price: 10, image: image_base_url + "ç‹å­éºµ.jpg", desc: "ä»¥å‰ä¸€åŒ…æ‰1å¡Šã€2å¡ŠéŒ¢ï¼Œæ˜¯å°å­©å­çš„é›¶é£Ÿã€‚" },
                    { name: "é»‘æ¾æ±½æ°´", price: 30, image: image_base_url + "é»‘æ¾æ±½æ°´.png", desc: "è¾¦æ¡Œã€è«‹å®¢ä¸€å®šè¦æœ‰çš„é£²æ–™ï¼" },
                    { name: "æ˜æ˜ŸèŠ±éœ²æ°´", price: 120, image: image_base_url + "æ˜æ˜ŸèŠ±éœ²æ°´.jpg", desc: "ä»¥å‰çš„é˜¿å¬¤éƒ½ç”¨é€™å€‹ï¼Œé¦™å™´å™´ï¼é‚„å¯ä»¥é˜²èšŠèŸ²ã€‚" },
                    { name: "æ°‘åœ‹ä¸ƒåå¹´ ä¸€å¼µã€Œæ„›åœ‹çåˆ¸ã€", price: 100, image: image_base_url + "æ°‘åœ‹ä¸ƒåå¹´ ä¸€å¼µã€Œæ„›åœ‹çåˆ¸ã€.jpg", desc: "åœ¨æ°‘åœ‹ä¸ƒåå¹´ä»£æœ«æœŸï¼Œçé‡‘é«˜çš„æ„›åœ‹çåˆ¸ä¸€å¼µè¦åƒ¹ä¸è²ã€‚" },
                    { name: "å½ˆç æ±½æ°´", price: 35, image: image_base_url + "å½ˆç æ±½æ°´.jpg", desc: "è¦ç”¨åŠ›æŠŠå½ˆç å£“ä¸‹å»ï¼Œå–å®Œé‚„è¦è’é›†å½ˆç ï¼" },
                    { name: "ç¶ æ²¹ç²¾", price: 50, image: image_base_url + "ç¶ æ²¹ç²¾.jpg", desc: "é ­æšˆã€èšŠå­å’¬ï¼Œä»€éº¼éƒ½èƒ½æ“¦ï¼Œæ˜¯å®¶åº­å¿…å‚™è‰¯è—¥ã€‚" }
                ] 
            },
            home: { 
                name: "ç”Ÿæ´»å¤§å°äº‹", 
                items: [
                    { name: "é›»å½±ç¥¨ (ä¸€å¼µ)", price: 300, image: image_base_url + "é›»å½±ç¥¨.jpg", desc: "ç¾åœ¨çœ‹é›»å½±å¾ˆè²´ï¼Œä»¥å‰çœ‹ä¸€å ´äºŒè¼ªç‰‡æ‰å¹¾åå¡Šã€‚" },
                    { name: "éå¹´ç´…åŒ… (ä¸€åŒ…)", price: 600, image: image_base_url + "åŒ…ç´…åŒ….jpg", desc: "åŒ…çµ¦å­«å­çš„å‰åˆ©æ•¸å­—ï¼Œå¸Œæœ›ä»–å¹³å®‰é•·å¤§ã€‚" },
                    { name: "å¤§åŒé›»é‹ (10äººä»½)", price: 2800, image: image_base_url + "å¤§åŒé›»é‹ (10äººä»½).jpg", desc: "æ¯å€‹å®¶åº­éƒ½æœ‰ä¸€å°ï¼Œå¾å¹´è¼•ç”¨åˆ°è€éƒ½ä¸æœƒå£ï¼" },
                    { name: "è—ç™½æ‹–", price: 80, image: image_base_url + "è—ç™½æ‹–.jpg", desc: "å°ç£æœ€æœ‰ä»£è¡¨æ€§çš„æ‹–é‹ï¼Œä¾¿å®œåˆå¥½ç©¿ã€‚" },
                    { name: "å…¬è·¯å±€è»Šç¥¨ (å°åŒ—åˆ°é«˜é›„)", price: 550, image: image_base_url + "å…¬è·¯å±€è»Šç¥¨ (å°åŒ—åˆ°é«˜é›„).jpg", desc: "ä»¥å‰å«ã€é‡‘é¦¬è™Ÿã€ï¼Œåé•·é€”è»Šçš„å›æ†¶ã€‚" }
                ] 
            },
            old_money: {
                name: "èˆŠæ™‚å…‰çš„è–ªæ°´è¢‹",
                type: "story", // æ¨™è¨˜é€™å€‹æ¨¡çµ„ç‚ºæ•…äº‹é¡å‹
                items: [
                    { name: "é€™æ˜¯ä»¥å‰çš„éŒ¢ï¼Œæ‚¨æœ‰çœ‹éå—ï¼Ÿ", image: image_base_url + "èˆŠå°å¹£.jpg", desc: "é€™äº›æ˜¯æ°‘åœ‹äº”åã€å…­åå¹´ä»£åœ¨ç”¨çš„éŒ¢å–”ï¼" },
                    { name: "é€™æ˜¯å¹¾å…ƒï¼Ÿä¸Šé¢çš„äººæ˜¯èª°ï¼Ÿ", image: image_base_url + "è”£ä¸­æ­£.jpg", desc: "æç¤ºï¼šé€™æ˜¯ä»¥å‰å¾ˆå¸¸è¦‹çš„åå…ƒç´™éˆ”ï¼Œä¸Šé¢æ˜¯è”£ä¸­æ­£ç¸½çµ±ã€‚" },
                    { name: "æ‚¨é‚„è¨˜å¾—ç¬¬ä¸€ä»½å·¥ä½œï¼Œä¸€å€‹æœˆé ˜å¤šå°‘éŒ¢å—ï¼Ÿ", image: image_base_url + "è–ªæ°´è¢‹.webp", desc: "ä»¥å‰çš„è–ªæ°´éƒ½æ˜¯ç”¨è–ªæ°´è¢‹ç™¼ç¾é‡‘çš„ï¼" },
                    { name: "é‚£æ™‚å€™ï¼Œé ˜åˆ°è–ªæ°´æœ€æƒ³è²·ä»€éº¼ï¼Ÿ", image: image_base_url + "PXL_20220207_062423742-EDIT.jpg", desc: "æ˜¯è²·æ–°è¡£ã€æ–°é‹ï¼Œé‚„æ˜¯å¸¶å®¶äººå»åƒå¥½æ–™çš„ï¼Ÿ" },
                    { name: "è³ºéŒ¢äº†å¾Œï¼Œæœ€å¤§çš„å¿«æ¨‚æ˜¯ä»€éº¼ï¼Ÿ", image: image_base_url + "éµé‘¾é¼»ç‡ˆå¡”.jpg", desc: "æ˜¯ç‚ºå®¶äººä»˜å‡ºï¼Œé‚„æ˜¯è²·è‡ªå·±å–œæ­¡çš„æ±è¥¿ï¼Ÿ" }
                ]
            }
        };

        // --- ç‹€æ…‹ç®¡ç† (State Management) ---
        let currentModuleKey = null;
        let currentItemIndex = 0;
        let currentModuleItems = [];
        let isTransitioning = false;

        // --- DOM å…ƒç´  ---
        const screens = {
            home: document.getElementById('home-screen'),
            moduleSelection: document.getElementById('module-selection-screen'),
            quiz: document.getElementById('quiz-screen'),
            story: document.getElementById('story-screen'),
            end: document.getElementById('end-screen'),
        };
        const startBtn = document.getElementById('start-btn');
        const moduleBtns = document.querySelectorAll('.module-btn');
        const restartBtn = document.getElementById('restart-btn');
        
        const backToMenuQuizBtn = document.getElementById('back-to-menu-quiz-btn');
        const quizModuleTitle = document.getElementById('quiz-module-title');
        const quizProgressText = document.getElementById('quiz-progress-text');
        const quizItemImage = document.getElementById('quiz-item-image');
        const quizItemName = document.getElementById('quiz-item-name');
        const quizItemDesc = document.getElementById('quiz-item-desc');
        const optionsArea = document.getElementById('options-area');
        const priceOptions = document.getElementById('price-options');
        const resultArea = document.getElementById('result-area');
        const resultText = document.getElementById('result-text');
        const explanationText = document.getElementById('explanation-text');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        
        const backToMenuStoryBtn = document.getElementById('back-to-menu-story-btn');
        const storyModuleTitle = document.getElementById('story-module-title');
        const storyItemImage = document.getElementById('story-item-image');
        const storyItemName = document.getElementById('story-item-name');
        const storyItemDesc = document.getElementById('story-item-desc');
        const nextStoryBtn = document.getElementById('next-story-btn');


        // --- æ ¸å¿ƒå‡½æ•¸ ---
        function showScreen(screenId) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            const screenToShow = screens[screenId];
            screenToShow.classList.remove('hidden');
            
            screenToShow.classList.remove('fade-in');
            void screenToShow.offsetWidth;
            screenToShow.classList.add('fade-in');
            
            const onAnimationEnd = () => {
                isTransitioning = false;
                screenToShow.removeEventListener('animationend', onAnimationEnd);
            };
            screenToShow.addEventListener('animationend', onAnimationEnd);
        }

        function selectQuizModule(moduleKey) {
            if (isTransitioning) return;
            isTransitioning = true;
            currentModuleKey = moduleKey;
            currentItemIndex = 0;
            currentModuleItems = [...database[moduleKey].items].sort(() => 0.5 - Math.random());
            displayQuizQuestion();
            showScreen('quiz');
        }
        
        function selectStoryModule(moduleKey) {
            if (isTransitioning) return;
            isTransitioning = true;
            currentModuleKey = moduleKey;
            currentItemIndex = 0;
            currentModuleItems = database[moduleKey].items;
            displayStoryItem();
            showScreen('story');
        }

        function displayQuizQuestion() {
            const item = currentModuleItems[currentItemIndex];
            quizModuleTitle.textContent = database[currentModuleKey].name;
            quizProgressText.textContent = `ç¬¬ ${currentItemIndex + 1} é¡Œ / å…± ${currentModuleItems.length} é¡Œ`;
            quizItemImage.src = item.image;
            quizItemImage.alt = item.name;
            quizItemName.textContent = item.name;
            quizItemDesc.textContent = item.desc;
            
            priceOptions.innerHTML = '';
            
            const options = generatePriceOptions(item.price);

            options.forEach(price => {
                const btn = document.createElement('button');
                btn.textContent = `${price} å…ƒ`;
                btn.dataset.price = price;
                btn.classList.add('option-btn', 'btn', 'w-full', 'text-3xl', 'py-8', 'rounded-xl', 'bg-amber-100', 'hover:bg-amber-200', 'border-amber-200');
                btn.addEventListener('click', () => checkGuess(price, item.price));
                priceOptions.appendChild(btn);
            });

            optionsArea.classList.remove('hidden');
            resultArea.classList.add('hidden');
        }
        
        function displayStoryItem() {
            const item = currentModuleItems[currentItemIndex];
            storyModuleTitle.textContent = database[currentModuleKey].name;
            storyItemImage.src = item.image;
            storyItemImage.alt = item.name;
            storyItemName.textContent = item.name;
            storyItemDesc.textContent = item.desc;

            if (currentItemIndex >= currentModuleItems.length - 1) {
                nextStoryBtn.textContent = "ä»Šå¤©è¾›è‹¦äº†ï¼";
            } else {
                nextStoryBtn.textContent = "ä¸‹ä¸€é ";
            }
        }
        
        function generatePriceOptions(correctPrice) {
            let options = new Set([correctPrice]);
            while (options.size < 4) {
                const factor = 0.5 + Math.random(); 
                let distractor = Math.round((correctPrice * factor) / 5) * 5;
                if (distractor <= 0) distractor = 5;
                
                if (distractor !== correctPrice) {
                    options.add(distractor);
                }
            }
            return Array.from(options).sort(() => Math.random() - 0.5);
        }

        function checkGuess(chosenPrice, correctPrice) {
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            
            const chosenBtn = document.querySelector(`.option-btn[data-price='${chosenPrice}']`);
            const correctBtn = document.querySelector(`.option-btn[data-price='${correctPrice}']`);

            if (chosenPrice === correctPrice) {
                chosenBtn.classList.add('correct');
                resultArea.classList.add('bg-green-50');
                resultArea.classList.remove('bg-red-50');
                resultText.textContent = "å®Œå…¨æ­£ç¢ºï¼å¤ªå²å®³äº†ï¼";
                explanationText.textContent = `æ²’éŒ¯ï¼Œç¾åœ¨å·®ä¸å¤šå°±æ˜¯ ${correctPrice} å…ƒå·¦å³ã€‚`;
            } else {
                if(chosenBtn) chosenBtn.classList.add('wrong');
                if(correctBtn) correctBtn.classList.add('correct');
                resultArea.classList.add('bg-red-50');
                resultArea.classList.remove('bg-green-50');
                resultText.textContent = "æ²’é—œä¿‚ï¼Œå†è©¦è©¦çœ‹ï¼";
                explanationText.textContent = `æ­£ç¢ºçš„åƒ¹éŒ¢å¤§ç´„æ˜¯ ${correctPrice} å…ƒå–”ã€‚`;
            }
            
            optionsArea.classList.add('hidden');
            resultArea.classList.remove('hidden');
            resultArea.classList.add('pop-in');

            if (currentItemIndex >= currentModuleItems.length - 1) {
                nextQuestionBtn.textContent = "å®Œæˆï¼è¿”å›é¸å–®";
            } else {
                nextQuestionBtn.textContent = "ä¸‹ä¸€é¡Œ";
            }
        }

        function handleNextQuestion() {
            if (isTransitioning) return;
            isTransitioning = true;

            currentItemIndex++;
            if (currentItemIndex < currentModuleItems.length) {
                displayQuizQuestion();
                isTransitioning = false; 
            } else {
                showScreen('moduleSelection');
            }
        }
        
        function handleNextStoryItem() {
            if (isTransitioning) return;
            isTransitioning = true;

            if (currentItemIndex >= currentModuleItems.length - 1) {
                showScreen('end');
            } else {
                currentItemIndex++;
                displayStoryItem();
                isTransitioning = false;
            }
        }

        // --- äº‹ä»¶ç›£è½ ---
        startBtn.addEventListener('click', () => {
            if (isTransitioning) return;
            isTransitioning = true;
            showScreen('moduleSelection');
        });

        restartBtn.addEventListener('click', () => {
            if (isTransitioning) return;
            isTransitioning = true;
            showScreen('home');
        });

        moduleBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const moduleKey = btn.dataset.module;
                if (database[moduleKey].type === 'story') {
                    selectStoryModule(moduleKey);
                } else {
                    selectQuizModule(moduleKey);
                }
            });
        });

        backToMenuQuizBtn.addEventListener('click', () => {
            if (isTransitioning) return;
            isTransitioning = true;
            showScreen('moduleSelection');
        });
        backToMenuStoryBtn.addEventListener('click', () => {
            if (isTransitioning) return;
            isTransitioning = true;
            showScreen('moduleSelection');
        });
        
        nextQuestionBtn.addEventListener('click', handleNextQuestion);
        nextStoryBtn.addEventListener('click', handleNextStoryItem);

    </script>
</body>
</html>
