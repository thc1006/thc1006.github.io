<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒæµOS v3.0a</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- v3.0 æ›´æ–°: æ–°å¢ä»»å‹™åœ–ç¤º -->
    <link href="https://css.gg/css?|trophy|chart|plant|list" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; }
        #plant-svg { transform-origin: bottom center; transition: transform 0.5s ease-in-out, filter 0.3s ease; }
        .plant-grow { animation: grow 0.5s ease-in-out forwards; }
        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.05); } }
        .plant-wilt { filter: saturate(0.5) contrast(0.8); transform: rotate(-1deg); }
        .btn-primary { @apply bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition-all duration-300; }
        .btn-primary:active { @apply scale-95; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transform transition-all duration-300; }
        .btn-secondary:active { @apply scale-95; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center transition-opacity duration-300 z-50; }
        
        .nav-item { @apply flex-1 text-center py-3 px-1 text-gray-400 rounded-full transition-all duration-300 flex flex-col items-center justify-center mx-1; transform: scale(0.95); }
        .nav-item.active { @apply bg-emerald-800 text-emerald-300; transform: scale(1); }
        .nav-icon { @apply h-6 w-6 mb-1; }

        .achievement-badge { @apply bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center transition-all duration-300 aspect-square; }
        .achievement-badge.unlocked { @apply bg-gradient-to-br from-emerald-800 to-green-800 border border-emerald-600 shadow-lg; }
        .achievement-icon { @apply text-4xl mb-2; }
        .achievement-badge.locked { @apply opacity-40 filter grayscale; }

        #toast-notification { @apply fixed top-5 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-6 rounded-full shadow-2xl z-50; @apply transform transition-all duration-500 ease-in-out; opacity: 0; visibility: hidden; transform: translate(-50%, -20px); }
        #toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }

        /* v3.0 æ–°å¢: ä»»å‹™æ¨£å¼ */
        .task-item { @apply bg-gray-800 p-4 rounded-lg flex items-center justify-between transition-all duration-300 cursor-pointer hover:bg-gray-700; }
        .task-pomodoro-display { @apply text-sm text-gray-400; }
        .task-pomodoro-display .actual { @apply text-amber-400; }
        .task-pomodoro-display .estimated { @apply text-gray-500; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <main class="flex-grow container mx-auto p-4 w-full">
        <!-- èŠ±åœ’é é¢ -->
        <div id="garden-page" class="text-center max-w-md mx-auto">
             <div class="absolute top-4 right-4"><button id="settings-button" class="text-gray-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div>
            <div id="focusing-task-display" class="h-12 text-center mb-2"></div>
            <div class="mb-4 h-64 flex items-center justify-center"><svg id="plant-svg" width="200" height="240" viewBox="0 0 200 240"><g id="plant-base"><path d="M20 230 C 40 210, 160 210, 180 230 L 20 230 Z" fill="#5c3c20"/></g><g id="plant-body"></g><g id="plant-rare-feature"></g></svg></div>
            <h2 id="plant-name" class="text-3xl font-bold text-emerald-300 mb-2"></h2>
            <div id="timer-display" class="text-7xl font-bold mb-4">25:00</div>
            <div class="w-full bg-gray-700 rounded-full h-4 mb-6"><div id="progress-bar" class="bg-emerald-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            <div class="space-y-4"><button id="start-button" class="btn-primary text-2xl w-full">é¸æ“‡ä¸€å€‹ä»»å‹™ä¾†é–‹å§‹</button><button id="distracted-button" class="btn-secondary hidden">æˆ‘åˆ†å¿ƒäº†</button></div>
        </div>
        
        <!-- v3.0 æ–°å¢: ä»»å‹™é é¢ -->
        <div id="tasks-page" class="hidden max-w-2xl mx-auto">
             <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">æˆ‘çš„ä»»å‹™</h1>
                <button id="add-task-button" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">æ–°å¢ä»»å‹™</button>
            </div>
            <div id="tasks-list" class="space-y-3">
                <!-- ä»»å‹™åˆ—è¡¨å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å„€è¡¨æ¿é é¢ -->
        <div id="dashboard-page" class="hidden max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„å„€è¡¨æ¿</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-amber-400" id="stats-total-time">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ™‚é•· (åˆ†)</div></div><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-cyan-400" id="stats-total-sessions">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ¬¡æ•¸</div></div><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-rose-400" id="stats-longest-streak">0</div><div class="text-sm text-gray-400">æœ€é•·é€£çºŒå°ˆæ³¨å¤©æ•¸</div></div></div>
            <div class="bg-gray-800 p-4 rounded-lg"><h2 class="text-xl font-semibold mb-2 text-center">æœ€è¿‘ä¸€é€±å°ˆæ³¨æ´»å‹•</h2><canvas id="focus-chart"></canvas></div>
        </div>

        <!-- æˆå°±é é¢ -->
        <div id="achievements-page" class="hidden max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„æˆå°±</h1>
            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>

    </main>
    
    <!-- v3.0 æ›´æ–°: åº•éƒ¨å°è¦½åˆ— -->
    <nav class="sticky bottom-0 bg-gray-800/80 backdrop-blur-sm border-t border-gray-700 flex justify-around p-2">
        <button data-page="dashboard-page" class="nav-item"><i class="gg-chart nav-icon"></i><span>å„€è¡¨æ¿</span></button>
        <button data-page="tasks-page" class="nav-item"><i class="gg-list nav-icon"></i><span>ä»»å‹™</span></button>
        <button data-page="garden-page" class="nav-item active"><i class="gg-plant nav-icon"></i><span>èŠ±åœ’</span></button>
        <button data-page="achievements-page" class="nav-item"><i class="gg-trophy nav-icon"></i><span>æˆå°±</span></button>
    </nav>
    
    <!-- å½ˆçª—å®¹å™¨ -->
    <div id="modals">
        <!-- ... å…¶ä»–å½ˆçª— (onboarding, settings, reminder) ... -->
        
        <!-- v3.0 æ–°å¢: æ–°å¢/ç·¨è¼¯ä»»å‹™å½ˆçª— -->
        <div id="task-modal" class="modal-overlay hidden">
             <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 id="task-modal-title" class="text-2xl font-bold">æ–°å¢ä»»å‹™</h2>
                    <button id="close-task-modal-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                <form id="task-form" class="p-6 space-y-4">
                    <input type="hidden" id="task-id-input">
                    <div><label for="task-name-input" class="block mb-2 font-semibold">ä»»å‹™åç¨±</label><input type="text" id="task-name-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="ä¾‹å¦‚ï¼šå®Œæˆç¬¬ä¸‰å­£å ±å‘Š" required></div>
                    <div><label for="task-icon-input" class="block mb-2 font-semibold">é¸æ“‡åœ–ç¤º</label><input type="text" id="task-icon-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="ä¾‹å¦‚ï¼šğŸ“Š (å¯è¼¸å…¥ Emoji)"></div>
                    <div><label for="task-pomodoros-input" class="block mb-2 font-semibold">é è¨ˆç•ªèŒ„é˜æ•¸é‡</label>
                        <select id="task-pomodoros-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg">
                            <option value="0">ç„¡é è¨ˆ</option>
                            <option value="1">1 ğŸ…</option>
                            <option value="2">2 ğŸ…</option>
                            <option value="3">3 ğŸ…</option>
                            <option value="4">4 ğŸ…</option>
                            <option value="5">5 ğŸ…</option>
                            <option value="8">8 ğŸ…</option>
                            <option value="10">10 ğŸ…</option>
                        </select>
                    </div>
                </form>
                <div class="p-6 border-t border-gray-700 flex flex-col space-y-2">
                    <button id="save-task-button" class="bg-emerald-600 hover:bg-emerald-700 text-white w-full text-lg py-3 rounded-lg">å„²å­˜ä»»å‹™</button>
                    <button id="delete-task-button" class="bg-red-800 hover:bg-red-700 text-white w-full text-center py-2 rounded-lg hidden">åˆªé™¤ä»»å‹™</button>
                </div>
            </div>
        </div>
        <div id="onboarding-modal" class="modal-overlay hidden"><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h1 class="text-3xl font-bold mb-4 text-emerald-300">æ­¡è¿ä¾†åˆ°å¿ƒæµOS</h1><p class="text-gray-300 mb-6">ä½ çš„å°ˆæ³¨åŠ›ï¼Œå°‡æœƒçŒæº‰ä¸€æ ªå°æ¨¹è‹—ï¼Œè®“å®ƒèŒå£¯æˆé•·ã€‚</p><form id="onboarding-form"><label for="plant-name-input" class="block mb-2 font-semibold">ç‚ºä½ çš„æ¤ç‰©å¤¥ä¼´å–å€‹åå­—å§ï¼</label><input type="text" id="plant-name-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ä¾‹å¦‚ï¼šå°ç¶ " required><button type="submit" class="btn-primary w-full">é–‹å§‹ç¨®æ¤</button></form></div></div>
        <div id="settings-modal" class="modal-overlay hidden"><div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col max-h-[90vh]"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">è¨­å®š</h2><button id="close-settings-button" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="p-6 space-y-4 overflow-y-auto"><div><label for="focus-duration-input" class="block mb-2 font-semibold">å°ˆæ³¨æ™‚é–“ (åˆ†é˜)</label><input type="number" id="focus-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="break-duration-input" class="block mb-2 font-semibold">ä¼‘æ¯æ™‚é–“ (åˆ†é˜)</label><input type="number" id="break-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="blocked-sites-input" class="block mb-2 font-semibold">åˆ†å¿ƒç¶²ç«™æ¸…å–®</label><textarea id="blocked-sites-input" rows="3" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="e.g., youtube.com"></textarea></div></div><div class="p-6 border-t border-gray-700"><button id="save-settings-button" class="btn-primary w-full text-lg py-3">å„²å­˜è¨­å®š</button></div></div></div>
    </div>
    
    <div id="toast-notification"><span id="toast-text"></span></div>

    <script>
        const DOMElements = {
            pages: document.querySelectorAll('main > div'),
            navButtons: document.querySelectorAll('.nav-item'),
            gardenPage: document.getElementById('garden-page'),
            tasksPage: document.getElementById('tasks-page'),
            dashboardPage: document.getElementById('dashboard-page'),
            achievementsPage: document.getElementById('achievements-page'),
            plantName: document.getElementById('plant-name'),
            timerDisplay: document.getElementById('timer-display'),
            progressBar: document.getElementById('progress-bar'),
            startButton: document.getElementById('start-button'),
            distractedButton: document.getElementById('distracted-button'),
            focusingTaskDisplay: document.getElementById('focusing-task-display'),
            // Tasks
            tasksList: document.getElementById('tasks-list'),
            addTaskButton: document.getElementById('add-task-button'),
            taskModal: document.getElementById('task-modal'),
            taskModalTitle: document.getElementById('task-modal-title'),
            closeTaskModalButton: document.getElementById('close-task-modal-button'),
            taskForm: document.getElementById('task-form'),
            taskIdInput: document.getElementById('task-id-input'),
            taskNameInput: document.getElementById('task-name-input'),
            taskIconInput: document.getElementById('task-icon-input'),
            taskPomodorosInput: document.getElementById('task-pomodoros-input'),
            saveTaskButton: document.getElementById('save-task-button'),
            deleteTaskButton: document.getElementById('delete-task-button'),
            // Other elements
            plantSvg:document.getElementById("plant-svg"),plantBody:document.getElementById("plant-body"),plantRareFeature:document.getElementById("plant-rare-feature"),sessionCount:document.getElementById("session-count"),onboardingModal:document.getElementById("onboarding-modal"),onboardingForm:document.getElementById("onboarding-form"),plantNameInput:document.getElementById("plant-name-input"),settingsButton:document.getElementById("settings-button"),settingsModal:document.getElementById("settings-modal"),closeSettingsButton:document.getElementById("close-settings-button"),saveSettingsButton:document.getElementById("save-settings-button"),focusDurationInput:document.getElementById("focus-duration-input"),breakDurationInput:document.getElementById("break-duration-input"),blockedSitesInput:document.getElementById("blocked-sites-input"),statsTotalTime:document.getElementById("stats-total-time"),statsTotalSessions:document.getElementById("stats-total-sessions"),statsLongestStreak:document.getElementById("stats-longest-streak"),focusChartCanvas:document.getElementById("focus-chart"),achievementsGrid:document.getElementById("achievements-grid"),toast:document.getElementById("toast-notification"),toastText:document.getElementById("toast-text")
        };
        let state = {}, focusChart = null;

        function resetState() {
            state = {
                mode: 'idle', // idle, focus, break
                timerId: null,
                currentTaskId: null,
                settings: { focusDuration: 25, breakDuration: 5 },
                // Data
                plantName: '',
                growthLevel: 0,
                tasks: [],
                focusHistory: [],
                achievements: [],
            };
        }
        function saveData() { localStorage.setItem('flowOSState_v3.0', JSON.stringify(state)); }
        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('flowOSState_v3.0'));
            if (savedData) {
                Object.assign(state, savedData);
                // Ensure new state properties exist for backward compatibility
                if (!state.tasks) state.tasks = [];
                return true;
            }
            return false;
        }

        const synth=new Tone.Synth().toDestination(),sounds={success:()=>synth.triggerAttackRelease("C5","8n",Tone.now()),start:()=>synth.triggerAttackRelease("C4","8n",Tone.now()),save:()=>synth.triggerAttackRelease("E5","8n",Tone.now()),achievement:()=>synth.triggerAttackRelease("G5","4n",Tone.now())};
        const plantStages=[`<path d="M100 210 L100 180" stroke="#73b865" stroke-width="4"/>`,`<path d="M100 210 L100 170" stroke="#73b865" stroke-width="5"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/>`,`<path d="M100 210 L100 160" stroke="#73b865" stroke-width="6"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/><path d="M100 175 C 120 165, 120 145, 100 135" stroke="#84cc76" stroke-width="4" fill="none"/>`];
        
        function renderTasksPage() {
            DOMElements.tasksList.innerHTML = '';
            if (state.tasks.length === 0) {
                DOMElements.tasksList.innerHTML = `<p class="text-center text-gray-400">é»æ“Šå³ä¸Šè§’æ–°å¢ä½ çš„ç¬¬ä¸€å€‹ä»»å‹™å§ï¼</p>`;
                return;
            }
            state.tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                taskEl.dataset.taskId = task.id;
                
                const tomatoes = Array(task.pomodorosActual || 0).fill('ğŸ…').join('');
                const estimatedTomatoes = Array(task.pomodorosEstimated || 0).fill('âšª').join('');

                taskEl.innerHTML = `
                    <div class="flex-grow flex items-center task-info">
                        <span class="text-3xl mr-4">${task.icon || 'ğŸ¯'}</span>
                        <div>
                            <span class="text-lg font-semibold">${task.name}</span>
                            <div class="task-pomodoro-display">
                                <span class="actual">${tomatoes}</span><span class="estimated">${estimatedTomatoes.substring(tomatoes.length)}</span>
                            </div>
                        </div>
                    </div>
                    <button data-task-id="${task.id}" class="start-task-button bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-full">
                        â–¶
                    </button>
                `;
                DOMElements.tasksList.appendChild(taskEl);
            });
        }

        function openTaskModal(task = null) {
            DOMElements.taskForm.reset();
            if (task) {
                DOMElements.taskModalTitle.textContent = "ç·¨è¼¯ä»»å‹™";
                DOMElements.taskIdInput.value = task.id;
                DOMElements.taskNameInput.value = task.name;
                DOMElements.taskIconInput.value = task.icon;
                DOMElements.taskPomodorosInput.value = task.pomodorosEstimated;
                DOMElements.deleteTaskButton.classList.remove('hidden');
            } else {
                DOMElements.taskModalTitle.textContent = "æ–°å¢ä»»å‹™";
                DOMElements.taskIdInput.value = '';
                DOMElements.deleteTaskButton.classList.add('hidden');
            }
            DOMElements.taskModal.classList.remove('hidden');
        }

        function saveTask() {
            const id = DOMElements.taskIdInput.value;
            const name = DOMElements.taskNameInput.value.trim();
            const icon = DOMElements.taskIconInput.value.trim();
            const pomodorosEstimated = parseInt(DOMElements.taskPomodorosInput.value, 10);
            if (!name) return;

            if (id) {
                const existingTask = state.tasks.find(t => t.id === id);
                if(existingTask) {
                    existingTask.name = name;
                    existingTask.icon = icon;
                    existingTask.pomodorosEstimated = pomodorosEstimated;
                }
            } else {
                state.tasks.push({ 
                    id: `t_${Date.now()}`, 
                    name, icon, 
                    pomodorosEstimated, 
                    pomodorosActual: 0,
                    completed: false
                });
            }
            saveData();
            renderTasksPage();
            DOMElements.taskModal.classList.add('hidden');
        }

        function deleteTask() {
            const id = DOMElements.taskIdInput.value;
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveData();
            renderTasksPage();
            DOMElements.taskModal.classList.add('hidden');
        }

        function updateFocusingTaskDisplay() {
            if(state.mode === 'focus' && state.currentTaskId) {
                const task = state.tasks.find(t => t.id === state.currentTaskId);
                if(task) {
                    DOMElements.focusingTaskDisplay.innerHTML = `<p class="text-gray-400">å°ˆæ³¨æ–¼: <span class="font-bold text-emerald-300">${task.icon || ''} ${task.name}</span></p>`;
                }
            } else {
                DOMElements.focusingTaskDisplay.innerHTML = '';
            }
        }
        
        function startFocusForTask(taskId) {
            if (state.mode !== 'idle') {
                showToast("è«‹å…ˆå®Œæˆç›®å‰çš„å°ˆæ³¨æˆ–ä¼‘æ¯ã€‚");
                return;
            }
            state.currentTaskId = taskId;
            switchPage('garden-page');
            startTimer('focus');
        }

        function startTimer(mode) {
            if (state.timerId) clearInterval(state.timerId);
            state.mode = mode;
            const duration = state.settings[mode === 'focus' ? 'focusDuration' : 'breakDuration'];
            let timeLeft = duration * 60;
            
            if (mode === 'focus') {
                if (!state.currentTaskId) {
                    DOMElements.startButton.textContent = 'è«‹å…ˆåˆ°ä»»å‹™é é¸æ“‡ä»»å‹™';
                    DOMElements.startButton.disabled = true;
                    return;
                }
                DOMElements.startButton.textContent = "å°ˆæ³¨ä¸­...";
                DOMElements.startButton.disabled = true;
                DOMElements.distractedButton.classList.remove('hidden');
            } else {
                DOMElements.startButton.textContent = `ä¼‘æ¯ä¸€ä¸‹ (${duration}:00)`;
                 DOMElements.distractedButton.classList.add('hidden');
            }
            
            updateFocusingTaskDisplay();
            
            state.timerId = setInterval(() => {
                timeLeft--;
                // Update timer display logic here...
                if (timeLeft < 0) {
                    clearInterval(state.timerId);
                    if (mode === 'focus') handleFocusComplete();
                    else handleBreakComplete();
                }
            }, 1000);
        }

        function handleFocusComplete() {
            // ... (éœ€è¦æ›´æ–°ä»¥å¢åŠ ç•ªèŒ„é˜è¨ˆæ•¸)
            const task = state.tasks.find(t => t.id === state.currentTaskId);
            if (task) {
                task.pomodorosActual = (task.pomodorosActual || 0) + 1;
            }
            state.growthLevel++;
            // ... (å…¶ä»–åŸæœ‰é‚è¼¯)
            saveData();
            renderTasksPage();
            startTimer('break');
        }
        
        function handleBreakComplete() {
            state.mode = 'idle';
            state.currentTaskId = null;
            DOMElements.startButton.textContent = "é¸æ“‡ä¸€å€‹ä»»å‹™ä¾†é–‹å§‹";
            DOMElements.startButton.disabled = true;
            updateFocusingTaskDisplay();
        }

        function switchPage(pageId) {
            DOMElements.pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            DOMElements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
            if (pageId === 'tasks-page') renderTasksPage();
            if (pageId === 'dashboard-page') { /* renderDashboard() logic */ }
            if (pageId === 'achievements-page') { /* renderAchievements() logic */ }
        }

        function init() {
            resetState();
            if(loadData()) {
                DOMElements.onboardingModal.classList.add('hidden');
            } else {
                DOMElements.onboardingModal.classList.remove('hidden');
            }
            DOMElements.startButton.disabled = true;
            // More init logic...
            switchPage('garden-page');
            updateFocusingTaskDisplay();
        }

        DOMElements.addTaskButton.addEventListener('click', () => openTaskModal());
        DOMElements.tasksList.addEventListener('click', e => {
            const startButton = e.target.closest('.start-task-button');
            const taskInfo = e.target.closest('.task-info');
            if(startButton) {
                startFocusForTask(startButton.dataset.taskId);
            } else if (taskInfo) {
                const task = state.tasks.find(t => t.id === taskInfo.closest('.task-item').dataset.taskId);
                openTaskModal(task);
            }
        });
        DOMElements.saveTaskButton.addEventListener('click', saveTask);
        DOMElements.deleteTaskButton.addEventListener('click', deleteTask);
        DOMElements.closeTaskModalButton.addEventListener('click', () => DOMElements.taskModal.classList.add('hidden'));
        DOMElements.navButtons.forEach(b => b.addEventListener('click', () => switchPage(b.dataset.page)));

        // Placeholder for other functions to avoid breaking the code
        function showToast(msg) { console.log("Toast:", msg); }
        
        init();
    </script>
</body>
</html>
