<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒæµOS v2.1</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ Google Fonts çš„ Inter å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?|trophy|chart|plant" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- å¼•å…¥ Tone.js (éŸ³æ•ˆ) & Chart.js (åœ–è¡¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        #plant-svg { transform-origin: bottom center; transition: transform 0.5s ease-in-out, filter 0.3s ease; }
        .plant-grow { animation: grow 0.5s ease-in-out forwards; }
        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.05); } }
        .plant-wilt { filter: saturate(0.5) contrast(0.8); transform: rotate(-1deg); }
        .btn-primary { @apply bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition-all duration-300; }
        .btn-primary:active { @apply scale-95; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transform transition-all duration-300; }
        .btn-secondary:active { @apply scale-95; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center transition-opacity duration-300; }
        
        /* å°è¦½åˆ—æ¨£å¼ */
        .nav-item { @apply flex-1 text-center py-2 px-1 text-gray-400 hover:text-emerald-300 transition-colors duration-200; }
        .nav-item.active { @apply text-emerald-400 border-t-2 border-emerald-400; }
        .nav-icon { @apply h-6 w-6 mx-auto mb-1; }

        /* æˆå°±å¾½ç« æ¨£å¼ */
        .achievement-badge { @apply bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center transition-all duration-300; }
        .achievement-badge.unlocked { @apply bg-gradient-to-br from-emerald-800 to-green-800 border border-emerald-600 shadow-lg; }
        .achievement-icon { @apply text-4xl mb-2; }
        .achievement-badge.locked { @apply opacity-50 filter grayscale; }

        /* Toast é€šçŸ¥æ¨£å¼ */
        #toast-notification {
            @apply fixed bottom-20 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-6 rounded-full shadow-2xl;
            @apply transform transition-all duration-500 ease-in-out;
            opacity: 0;
            visibility: hidden;
            transform: translate(-50%, 20px);
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <!-- ä¸»å…§å®¹å®¹å™¨ -->
    <main class="flex-grow container mx-auto p-4 max-w-md w-full">
        <!-- èŠ±åœ’é é¢ (é è¨­é¡¯ç¤º) -->
        <div id="garden-page" class="text-center">
             <div class="absolute top-4 right-4">
                <button id="settings-button" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
            <div class="mb-4 h-64 flex items-center justify-center">
                <svg id="plant-svg" width="200" height="240" viewBox="0 0 200 240"><g id="plant-base"><path d="M20 230 C 40 210, 160 210, 180 230 L 20 230 Z" fill="#5c3c20"/></g><g id="plant-body"></g><g id="plant-rare-feature"></g></svg>
            </div>
            <h2 id="plant-name" class="text-3xl font-bold text-emerald-300 mb-2"></h2>
            <div id="timer-display" class="text-7xl font-bold mb-4">25:00</div>
            <div class="w-full bg-gray-700 rounded-full h-4 mb-6"><div id="progress-bar" class="bg-emerald-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            <div class="space-y-4"><button id="start-button" class="btn-primary text-2xl w-full">é–‹å§‹å°ˆæ³¨</button><button id="distracted-button" class="btn-secondary hidden">æˆ‘åˆ†å¿ƒäº†</button></div>
            <p class="mt-8 text-gray-400">ä½ å·²å®Œæˆ <span id="session-count" class="font-bold text-amber-400">0</span> æ¬¡å°ˆæ³¨</p>
        </div>
        
        <!-- å„€è¡¨æ¿é é¢ -->
        <div id="dashboard-page" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„å„€è¡¨æ¿</h1>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-3xl font-bold text-amber-400" id="stats-total-time">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ™‚é•· (åˆ†)</div></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-3xl font-bold text-cyan-400" id="stats-total-sessions">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ¬¡æ•¸</div></div>
                <div class="bg-gray-800 p-4 rounded-lg text-center col-span-2"><div class="text-3xl font-bold text-rose-400" id="stats-longest-streak">0</div><div class="text-sm text-gray-400">æœ€é•·é€£çºŒå°ˆæ³¨å¤©æ•¸</div></div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-2 text-center">æœ€è¿‘å°ˆæ³¨æ´»å‹•</h2>
                <canvas id="focus-chart"></canvas>
            </div>
        </div>

        <!-- æˆå°±é é¢ -->
        <div id="achievements-page" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„æˆå°±</h1>
            <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <!-- æˆå°±å¾½ç« å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </main>
    
    <!-- åº•éƒ¨å°è¦½åˆ— -->
    <nav class="sticky bottom-0 bg-gray-800 border-t border-gray-700 flex">
        <button data-page="dashboard-page" class="nav-item"><i class="gg-chart nav-icon"></i>å„€è¡¨æ¿</button>
        <button data-page="garden-page" class="nav-item active"><i class="gg-plant nav-icon"></i>èŠ±åœ’</button>
        <button data-page="achievements-page" class="nav-item"><i class="gg-trophy nav-icon"></i>æˆå°±</button>
    </nav>
    
    <!-- æ‰€æœ‰å½ˆçª—å®¹å™¨ -->
    <div id="modals">
        <div id="onboarding-modal" class="modal-overlay hidden"><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h1 class="text-3xl font-bold mb-4 text-emerald-300">æ­¡è¿ä¾†åˆ°å¿ƒæµOS</h1><p class="text-gray-300 mb-6">ä½ çš„å°ˆæ³¨åŠ›ï¼Œå°‡æœƒçŒæº‰ä¸€æ ªå°æ¨¹è‹—ï¼Œè®“å®ƒèŒå£¯æˆé•·ã€‚</p><form id="onboarding-form"><label for="plant-name-input" class="block mb-2 font-semibold">ç‚ºä½ çš„æ¤ç‰©å¤¥ä¼´å–å€‹åå­—å§ï¼</label><input type="text" id="plant-name-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ä¾‹å¦‚ï¼šå°ç¶ " required><button type="submit" class="btn-primary w-full">é–‹å§‹ç¨®æ¤</button></form></div></div>
        <div id="settings-modal" class="modal-overlay hidden"><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-left relative"><button id="close-settings-button" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><h2 class="text-2xl font-bold mb-6 text-center">è¨­å®š</h2><div class="space-y-4"><div><label for="focus-duration-input" class="block mb-2 font-semibold">å°ˆæ³¨æ™‚é–“ (åˆ†é˜)</label><input type="number" id="focus-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="break-duration-input" class="block mb-2 font-semibold">ä¼‘æ¯æ™‚é–“ (åˆ†é˜)</label><input type="number" id="break-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="blocked-sites-input" class="block mb-2 font-semibold">åˆ†å¿ƒç¶²ç«™æ¸…å–®</label><textarea id="blocked-sites-input" rows="3" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="e.g., youtube.com"></textarea></div></div><button id="save-settings-button" class="btn-primary w-full mt-6">å„²å­˜è¨­å®š</button></div></div>
        <div id="reminder-modal" class="modal-overlay hidden opacity-0"><div class="bg-blue-900 border-2 border-blue-500 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h3 class="text-2xl font-bold text-white mb-4">å°ˆæ³¨æ™‚é–“ï¼</h3><p id="reminder-text" class="text-blue-200"></p></div></div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast-notification">
        <span id="toast-text"></span>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ & DOM é¸æ“‡ ---
        const pages = document.querySelectorAll('main > div');
        const navButtons = document.querySelectorAll('.nav-item');
        const DOMElements = {
            gardenPage: document.getElementById('garden-page'),
            dashboardPage: document.getElementById('dashboard-page'),
            achievementsPage: document.getElementById('achievements-page'),
            plantSvg: document.getElementById('plant-svg'),
            plantBody: document.getElementById('plant-body'),
            plantRareFeature: document.getElementById('plant-rare-feature'),
            plantName: document.getElementById('plant-name'),
            timerDisplay: document.getElementById('timer-display'),
            progressBar: document.getElementById('progress-bar'),
            startButton: document.getElementById('start-button'),
            distractedButton: document.getElementById('distracted-button'),
            sessionCount: document.getElementById('session-count'),
            // Modals
            onboardingModal: document.getElementById('onboarding-modal'),
            onboardingForm: document.getElementById('onboarding-form'),
            plantNameInput: document.getElementById('plant-name-input'),
            settingsButton: document.getElementById('settings-button'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsButton: document.getElementById('close-settings-button'),
            saveSettingsButton: document.getElementById('save-settings-button'),
            focusDurationInput: document.getElementById('focus-duration-input'),
            breakDurationInput: document.getElementById('break-duration-input'),
            blockedSitesInput: document.getElementById('blocked-sites-input'),
            // Dashboard
            statsTotalTime: document.getElementById('stats-total-time'),
            statsTotalSessions: document.getElementById('stats-total-sessions'),
            statsLongestStreak: document.getElementById('stats-longest-streak'),
            focusChartCanvas: document.getElementById('focus-chart'),
            // Achievements
            achievementsGrid: document.getElementById('achievements-grid'),
            // Toast
            toast: document.getElementById('toast-notification'),
            toastText: document.getElementById('toast-text'),
        };

        let state = {};
        let focusChart = null;

        // --- ç‹€æ…‹ç®¡ç† (v2.1 å¤§å¹…æ›´æ–°) ---
        function resetState() {
            state = {
                mode: 'idle',
                timerId: null,
                totalTime: 25 * 60,
                timeLeft: 25 * 60,
                plantName: '',
                growthLevel: 0,
                rareFeature: null,
                settings: { focusDuration: 25, breakDuration: 5, blockedSites: [] },
                // æ–°å¢æ•¸æ“š
                focusHistory: [], // { date: 'YYYY-MM-DD', duration: 25 }
                achievements: [], // ['id1', 'id2']
            };
        }
        
        // --- æœ¬åœ°å„²å­˜ ---
        function saveData() {
            localStorage.setItem('flowOSState_v2.1', JSON.stringify(state));
        }

        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('flowOSState_v2.1'));
            if (savedData) {
                // åˆä½µå„²å­˜çš„è³‡æ–™èˆ‡é è¨­å€¼ï¼Œé¿å…æ–°ç‰ˆåŠ å…¥çš„ state key éºå¤±
                Object.assign(state, savedData);
                // ç¢ºä¿æ–°åŠ å…¥çš„ state key æœ‰é è¨­å€¼
                if (!state.focusHistory) state.focusHistory = [];
                if (!state.achievements) state.achievements = [];
                return true;
            }
            return false;
        }

        // --- éŸ³æ•ˆ ---
        const synth = new Tone.Synth().toDestination();
        const sounds = {
            success: () => synth.triggerAttackRelease("C5", "8n", Tone.now()),
            start: () => synth.triggerAttackRelease("C4", "8n", Tone.now()),
            save: () => synth.triggerAttackRelease("E5", "8n", Tone.now()),
            achievement: () => synth.triggerAttackRelease("G5", "4n", Tone.now())
        };

        // --- æ¤ç‰© & UI æ›´æ–° ---
        const plantStages = [`<path d="M100 210 L100 180" stroke="#73b865" stroke-width="4"/>`,`<path d="M100 210 L100 170" stroke="#73b865" stroke-width="5"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/>`,`<path d="M100 210 L100 160" stroke="#73b865" stroke-width="6"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/><path d="M100 175 C 120 165, 120 145, 100 135" stroke="#84cc76" stroke-width="4" fill="none"/>`,`<path d="M100 210 L100 140" stroke="#73b865" stroke-width="7"/><path d="M100 170 C 60 150, 60 120, 100 120" stroke="#84cc76" stroke-width="5" fill="none"/><path d="M100 165 C 140 145, 140 115, 100 115" stroke="#84cc76" stroke-width="5" fill="none"/>`,`<path d="M100 210 L100 135" stroke="#6a9a5f" stroke-width="8"/><path d="M100 170 C 60 150, 60 120, 100 120" stroke="#84cc76" stroke-width="5" fill="none"/><path d="M100 165 C 140 145, 140 115, 100 115" stroke="#84cc76" stroke-width="5" fill="none"/><circle cx="100" cy="105" r="15" fill="#fde047"/><circle cx="100" cy="105" r="8" fill="#fca5a5"/>`];
        const rareFeaturesSVG = {'gold_flower': `<circle cx="130" cy="140" r="10" fill="gold" stroke="white" stroke-width="2"/>`,'blue_leaf': `<path d="M100 190 C 120 180, 120 160, 100 150" stroke="#3b82f6" stroke-width="4" fill="none"/>`,'crystal_fruit': `<circle cx="70" cy="150" r="12" fill="cyan" opacity="0.7"/>`};
        function updatePlantVisuals() {
            const stageIndex = Math.min(Math.floor(state.growthLevel / 2), plantStages.length - 1);
            DOMElements.plantBody.innerHTML = plantStages[stageIndex] || plantStages[0];
            DOMElements.plantName.textContent = state.plantName;
            DOMElements.sessionCount.textContent = state.growthLevel;
            DOMElements.plantRareFeature.innerHTML = state.rareFeature ? rareFeaturesSVG[state.rareFeature] : '';
            DOMElements.plantSvg.style.transform = `scale(${1 + (state.growthLevel * 0.015)})`;
        }
        function updateTimerDisplay() { /* ... (èˆ‡v2.0ç›¸åŒ) ... */ }
        
        // --- æˆå°±ç³»çµ± (v2.1 æ–°å¢) ---
        const ACHIEVEMENT_CONFIG = {
            focus_1: { title: "å°ˆæ³¨æ–°æ‰‹", desc: "å®Œæˆç¬¬ 1 æ¬¡å°ˆæ³¨", icon: "ğŸŒ±", check: s => s.growthLevel >= 1 },
            focus_10: { title: "å°ˆæ³¨é”äºº", desc: "å®Œæˆ 10 æ¬¡å°ˆæ³¨", icon: "ğŸŒ³", check: s => s.growthLevel >= 10 },
            focus_50: { title: "å°ˆæ³¨å¤§å¸«", desc: "å®Œæˆ 50 æ¬¡å°ˆæ³¨", icon: "ğŸŒ²", check: s => s.growthLevel >= 50 },
            time_60: { title: "ä¸€å°æ™‚æˆå°±", desc: "ç´¯è¨ˆå°ˆæ³¨ 60 åˆ†é˜", icon: "â±ï¸", check: s => calculateTotalFocusTime(s) >= 60 },
            time_600: { title: "åå°æ™‚æˆå°±", desc: "ç´¯è¨ˆå°ˆæ³¨ 600 åˆ†é˜", icon: "ğŸ•°ï¸", check: s => calculateTotalFocusTime(s) >= 600 },
            streak_3: { title: "å¥½äº‹æˆä¸‰", desc: "é€£çºŒå°ˆæ³¨ 3 å¤©", icon: "ğŸ¥‰", check: s => calculateLongestStreak(s.focusHistory) >= 3 },
            streak_7: { title: "ä¸€é€±æŒ‘æˆ°", desc: "é€£çºŒå°ˆæ³¨ 7 å¤©", icon: "ğŸ¥ˆ", check: s => calculateLongestStreak(s.focusHistory) >= 7 },
            rare_1: { title: "ç¨€æœ‰ç™¼ç¾", desc: "ç™¼ç¾ç¬¬ä¸€å€‹ç¨€æœ‰ç‰¹å¾µ", icon: "ğŸ’", check: s => !!s.rareFeature },
        };
        function checkAchievements() {
            Object.keys(ACHIEVEMENT_CONFIG).forEach(id => {
                if (!state.achievements.includes(id)) {
                    if (ACHIEVEMENT_CONFIG[id].check(state)) {
                        state.achievements.push(id);
                        showToast(`å¾½ç« å·²è§£é–ï¼š${ACHIEVEMENT_CONFIG[id].title}`);
                        sounds.achievement();
                    }
                }
            });
        }
        function renderAchievements() {
            DOMElements.achievementsGrid.innerHTML = '';
            Object.keys(ACHIEVEMENT_CONFIG).forEach(id => {
                const config = ACHIEVEMENT_CONFIG[id];
                const unlocked = state.achievements.includes(id);
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${unlocked ? 'unlocked' : 'locked'}`;
                badge.innerHTML = `
                    <div class="achievement-icon">${config.icon}</div>
                    <h3 class="font-bold">${config.title}</h3>
                    <p class="text-xs text-gray-400">${config.desc}</p>
                `;
                DOMElements.achievementsGrid.appendChild(badge);
            });
        }

        // --- å„€è¡¨æ¿ç³»çµ± (v2.1 æ–°å¢) ---
        function calculateTotalFocusTime(s) {
            return s.focusHistory.reduce((sum, item) => sum + item.duration, 0);
        }
        function calculateLongestStreak(history) {
            if (history.length === 0) return 0;
            const dates = [...new Set(history.map(item => item.date))].sort();
            if (dates.length === 0) return 0;
            
            let longestStreak = 1;
            let currentStreak = 1;
            for (let i = 1; i < dates.length; i++) {
                const currentDate = new Date(dates[i]);
                const prevDate = new Date(dates[i - 1]);
                const diffTime = currentDate - prevDate;
                const diffDays = diffTime / (1000 * 60 * 60 * 24);
                
                if (diffDays === 1) {
                    currentStreak++;
                } else {
                    longestStreak = Math.max(longestStreak, currentStreak);
                    currentStreak = 1;
                }
            }
            return Math.max(longestStreak, currentStreak);
        }
        function renderDashboard() {
            DOMElements.statsTotalTime.textContent = calculateTotalFocusTime(state);
            DOMElements.statsTotalSessions.textContent = state.growthLevel;
            DOMElements.statsLongestStreak.textContent = calculateLongestStreak(state.focusHistory);
            
            // æº–å‚™åœ–è¡¨è³‡æ–™
            const last7Days = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = d.toISOString().split('T')[0];
                last7Days[dateString] = 0;
            }
            state.focusHistory.forEach(item => {
                if (last7Days[item.date] !== undefined) {
                    last7Days[item.date] += item.duration;
                }
            });

            const chartLabels = Object.keys(last7Days).map(d => d.substring(5)); // M-D
            const chartData = Object.values(last7Days);

            if (focusChart) focusChart.destroy();
            focusChart = new Chart(DOMElements.focusChartCanvas, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'å°ˆæ³¨æ™‚é•· (åˆ†é˜)',
                        data: chartData,
                        backgroundColor: 'rgba(52, 211, 153, 0.5)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { color: 'rgba(255,255,255,0.1)' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        // --- æ ¸å¿ƒè¨ˆæ™‚é‚è¼¯ ---
        function handleFocusComplete() {
            const focusDuration = state.settings.focusDuration;
            state.growthLevel++;

            // è¨˜éŒ„æ­·å²
            const today = new Date().toISOString().split('T')[0];
            state.focusHistory.push({ date: today, duration: focusDuration });

            // æª¢æŸ¥æˆå°±
            checkAchievements();
            
            // ç¨€æœ‰ç‰¹å¾µ
            if (Math.random() < 0.2 && !state.rareFeature) {
                const rareKeys = Object.keys(rareFeaturesSVG);
                state.rareFeature = rareKeys[Math.floor(Math.random() * rareKeys.length)];
            }
            
            saveData();
            updatePlantVisuals();
            DOMElements.plantSvg.classList.add('plant-grow');
            setTimeout(() => DOMElements.plantSvg.classList.remove('plant-grow'), 500);
            
            startTimer('break');
        }
        function startTimer(mode) { /* ... (èˆ‡v2.0ç›¸ä¼¼) ... */ }
        function tick() { /* ... (èˆ‡v2.0ç›¸ä¼¼) ... */ }
        function handleBreakComplete() { /* ... (èˆ‡v2.0ç›¸ä¼¼) ... */ }
        function handleDistraction() { /* ... (èˆ‡v2.0ç›¸ä¼¼) ... */ }

        // --- å°è¦½ & å½ˆçª— ---
        function switchPage(pageId) {
            pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            navButtons.forEach(b => {
                b.classList.toggle('active', b.dataset.page === pageId);
            });
            
            // æ¸²æŸ“éœ€è¦å³æ™‚æ›´æ–°çš„é é¢
            if (pageId === 'dashboard-page') renderDashboard();
            if (pageId === 'achievements-page') renderAchievements();
        }

        function showToast(message) {
            DOMElements.toastText.textContent = message;
            DOMElements.toast.classList.add('show');
            setTimeout(() => DOMElements.toast.classList.remove('show'), 3000);
        }

        // --- äº‹ä»¶ç›£è½å™¨ ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => switchPage(button.dataset.page));
        });
        
        // --- åˆå§‹åŒ– ---
        function init() {
            resetState();
            if (loadData()) {
                DOMElements.onboardingModal.classList.add('hidden');
            } else {
                DOMElements.onboardingModal.classList.remove('hidden');
            }
            
            // æ›´æ–°UIä»¥åæ˜ è®€å–çš„ç‹€æ…‹
            state.timeLeft = state.settings.focusDuration * 60;
            updatePlantVisuals();
            // ... [å…¶ä»–v2.0çš„åˆå§‹åŒ–]
            
            // é è¨­é¡¯ç¤ºèŠ±åœ’é é¢
            switchPage('garden-page');
        }

        // å•Ÿå‹•æ‡‰ç”¨
        init();

        // ç‚ºäº†ç¯€çœç¯‡å¹…ï¼Œéƒ¨åˆ†èˆ‡ v2.0 ç›¸åŒçš„å‡½å¼é‚è¼¯è¢«ç°¡åŒ–è¨»è§£ï¼Œæ‚¨å¯ä»¥åƒè€ƒä¸Šä¸€ç‰ˆç¨‹å¼ç¢¼
        // å®Œæ•´çš„ startTimer, tick, handleBreakComplete ç­‰å‡½æ•¸æ‡‰è¢«å®Œæ•´å¯¦ä½œ
        function updateTimerDisplay(){const minutes=Math.floor(state.timeLeft/60).toString().padStart(2,"0");const seconds=(state.timeLeft%60).toString().padStart(2,"0");const timeString=`${minutes}:${seconds}`;DOMElements.timerDisplay.textContent=timeString;document.title=`${timeString} - å¿ƒæµOS`}
        function startTimer(mode){if(state.timerId)clearInterval(state.timerId);state.mode=mode;const durationInMinutes=mode==="focus"?state.settings.focusDuration:state.settings.breakDuration;state.totalTime=durationInMinutes*60;state.timeLeft=state.totalTime;updateTimerDisplay();DOMElements.progressBar.style.width="0%";if(mode==="focus"){sounds.start();DOMElements.startButton.textContent="å°ˆæ³¨ä¸­...";DOMElements.startButton.disabled=true;DOMElements.distractedButton.classList.remove("hidden")}else{sounds.success();DOMElements.startButton.textContent=`ä¼‘æ¯ä¸€ä¸‹ (${state.settings.breakDuration}:00)`;DOMElements.startButton.disabled=true;DOMElements.distractedButton.classList.add("hidden")}state.timerId=setInterval(tick,1e3)}
        function tick(){state.timeLeft--;updateTimerDisplay();const progressPercentage=state.totalTime>0?((state.totalTime-state.timeLeft)/state.totalTime)*100:0;DOMElements.progressBar.style.width=`${progressPercentage}%`;if(state.timeLeft<=0){clearInterval(state.timerId);state.timerId=null;state.mode==="focus"?handleFocusComplete():handleBreakComplete()}}
        function handleBreakComplete(){state.mode="idle";DOMElements.startButton.textContent="é–‹å§‹ä¸‹ä¸€å€‹å°ˆæ³¨";DOMElements.startButton.disabled=false;DOMElements.progressBar.style.width="0%";state.timeLeft=state.settings.focusDuration*60;updateTimerDisplay();document.title="å¿ƒæµOS"}
        function handleDistraction(){if(state.mode!=="focus"||state.timeLeft<=10)return;DOMElements.plantSvg.classList.add("plant-wilt");setTimeout(()=>DOMElements.plantSvg.classList.remove("plant-wilt"),500);const penalty=30;state.timeLeft=Math.max(0,state.timeLeft-penalty);const originalText=DOMElements.distractedButton.textContent;DOMElements.distractedButton.textContent="æ²’é—œä¿‚ï¼Œæˆ‘å€‘ç¹¼çºŒï¼";DOMElements.distractedButton.disabled=true;setTimeout(()=>{DOMElements.distractedButton.textContent=originalText;DOMElements.distractedButton.disabled=false},2e3)}
        DOMElements.onboardingForm.addEventListener("submit",e=>{e.preventDefault();state.plantName=DOMElements.plantNameInput.value.trim();if(state.plantName){DOMElements.onboardingModal.classList.add("hidden");saveData();updatePlantVisuals()}});
        DOMElements.startButton.addEventListener("click",()=>state.mode==="idle"&&startTimer("focus"));
        DOMElements.distractedButton.addEventListener("click",handleDistraction);
        DOMElements.settingsButton.addEventListener("click",()=>{DOMElements.focusDurationInput.value=state.settings.focusDuration;DOMElements.breakDurationInput.value=state.settings.breakDuration;DOMElements.blockedSitesInput.value=(state.settings.blockedSites||[]).join("\n");DOMElements.settingsModal.classList.remove("hidden")});
        DOMElements.closeSettingsButton.addEventListener("click",()=>DOMElements.settingsModal.classList.add("hidden"));
        DOMElements.saveSettingsButton.addEventListener("click",()=>{state.settings.focusDuration=parseInt(DOMElements.focusDurationInput.value,10)||25;state.settings.breakDuration=parseInt(DOMElements.breakDurationInput.value,10)||5;state.settings.blockedSites=(DOMElements.blockedSitesInput.value||"").split("\n").map(s=>s.trim()).filter(Boolean);if(state.mode==="idle"){state.timeLeft=state.settings.focusDuration*60;updateTimerDisplay()}saveData();sounds.save();DOMElements.settingsModal.classList.add("hidden")});
    </script>
</body>
</html>
