<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒæµOS v2.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css?|trophy|chart|plant|check" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #111827; }
        #plant-svg { transform-origin: bottom center; transition: transform 0.5s ease-in-out, filter 0.3s ease; }
        .plant-grow { animation: grow 0.5s ease-in-out forwards; }
        @keyframes grow { from { transform: scale(1); } to { transform: scale(1.05); } }
        .plant-wilt { filter: saturate(0.5) contrast(0.8); transform: rotate(-1deg); }
        .btn-primary { @apply bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-full shadow-lg transform transition-all duration-300; }
        .btn-primary:active { @apply scale-95; }
        .btn-secondary { @apply bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full shadow-md transform transition-all duration-300; }
        .btn-secondary:active { @apply scale-95; }
        .modal-overlay { @apply fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center transition-opacity duration-300 z-50; }
        
        .nav-item { @apply flex-1 text-center py-3 px-1 text-gray-400 rounded-full transition-all duration-300 flex flex-col items-center justify-center mx-1; transform: scale(0.95); }
        .nav-item.active { @apply bg-emerald-800 text-emerald-300; transform: scale(1); }
        .nav-icon { @apply h-6 w-6 mb-1; }

        .achievement-badge { @apply bg-gray-800 p-4 rounded-lg flex flex-col items-center justify-center text-center transition-all duration-300 aspect-square; }
        .achievement-badge.unlocked { @apply bg-gradient-to-br from-emerald-800 to-green-800 border border-emerald-600 shadow-lg; }
        .achievement-icon { @apply text-4xl mb-2; }
        .achievement-badge.locked { @apply opacity-40 filter grayscale; }

        #toast-notification { @apply fixed top-5 left-1/2 -translate-x-1/2 bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 px-6 rounded-full shadow-2xl z-50; @apply transform transition-all duration-500 ease-in-out; opacity: 0; visibility: hidden; transform: translate(-50%, -20px); }
        #toast-notification.show { opacity: 1; visibility: visible; transform: translate(-50%, 0); }

        /* v2.3 æ–°å¢: ç¿’æ…£æ‰“å¡æ¨£å¼ */
        .habit-item { @apply bg-gray-800 p-4 rounded-lg flex items-center justify-between transition-colors duration-300; }
        .habit-check-button { @apply w-12 h-12 flex items-center justify-center rounded-full text-2xl transition-all duration-300; }
        .habit-check-button.pending { @apply bg-gray-700 hover:bg-gray-600; }
        .habit-check-button.checked { @apply bg-green-500 text-white; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <main class="flex-grow container mx-auto p-4 w-full">
        <!-- èŠ±åœ’é é¢ -->
        <div id="garden-page" class="text-center max-w-md mx-auto">
             <div class="absolute top-4 right-4"><button id="settings-button" class="text-gray-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></button></div>
            <div class="mb-4 h-64 flex items-center justify-center"><svg id="plant-svg" width="200" height="240" viewBox="0 0 200 240"><g id="plant-base"><path d="M20 230 C 40 210, 160 210, 180 230 L 20 230 Z" fill="#5c3c20"/></g><g id="plant-body"></g><g id="plant-rare-feature"></g></svg></div>
            <h2 id="plant-name" class="text-3xl font-bold text-emerald-300 mb-2"></h2>
            <div id="timer-display" class="text-7xl font-bold mb-4">25:00</div>
            <div class="w-full bg-gray-700 rounded-full h-4 mb-6"><div id="progress-bar" class="bg-emerald-400 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            <div class="space-y-4"><button id="start-button" class="btn-primary text-2xl w-full">é–‹å§‹å°ˆæ³¨</button><button id="distracted-button" class="btn-secondary hidden">æˆ‘åˆ†å¿ƒäº†</button></div>
            <p class="mt-8 text-gray-400">ä½ å·²å®Œæˆ <span id="session-count" class="font-bold text-amber-400">0</span> æ¬¡å°ˆæ³¨</p>
        </div>
        
        <!-- å„€è¡¨æ¿é é¢ -->
        <div id="dashboard-page" class="hidden max-w-2xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„å„€è¡¨æ¿</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-amber-400" id="stats-total-time">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ™‚é•· (åˆ†)</div></div><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-cyan-400" id="stats-total-sessions">0</div><div class="text-sm text-gray-400">ç¸½å°ˆæ³¨æ¬¡æ•¸</div></div><div class="bg-gray-800 p-4 rounded-lg text-center"><div class="text-4xl font-bold text-rose-400" id="stats-longest-streak">0</div><div class="text-sm text-gray-400">æœ€é•·é€£çºŒå°ˆæ³¨å¤©æ•¸</div></div></div>
            <div class="bg-gray-800 p-4 rounded-lg"><h2 class="text-xl font-semibold mb-2 text-center">æœ€è¿‘ä¸€é€±å°ˆæ³¨æ´»å‹•</h2><canvas id="focus-chart"></canvas></div>
        </div>

        <!-- æˆå°±é é¢ -->
        <div id="achievements-page" class="hidden max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-6">æˆ‘çš„æˆå°±</h1>
            <div id="achievements-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>

        <!-- v2.3 æ–°å¢: ç¿’æ…£æ‰“å¡é é¢ -->
        <div id="habits-page" class="hidden max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold">æˆ‘çš„ç¿’æ…£</h1>
                <button id="add-habit-button" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">æ–°å¢ç¿’æ…£</button>
            </div>
            <div id="habits-list" class="space-y-3">
                <!-- ç¿’æ…£åˆ—è¡¨å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </main>
    
    <!-- v2.3 æ›´æ–°: åº•éƒ¨å°è¦½åˆ— (å››å€‹æŒ‰éˆ•) -->
    <nav class="sticky bottom-0 bg-gray-800/80 backdrop-blur-sm border-t border-gray-700 flex justify-around p-2">
        <button data-page="dashboard-page" class="nav-item"><i class="gg-chart nav-icon"></i><span>å„€è¡¨æ¿</span></button>
        <button data-page="garden-page" class="nav-item active"><i class="gg-plant nav-icon"></i><span>èŠ±åœ’</span></button>
        <button data-page="habits-page" class="nav-item"><i class="gg-check nav-icon"></i><span>ç¿’æ…£</span></button>
        <button data-page="achievements-page" class="nav-item"><i class="gg-trophy nav-icon"></i><span>æˆå°±</span></button>
    </nav>
    
    <!-- å½ˆçª—å®¹å™¨ -->
    <div id="modals">
        <div id="onboarding-modal" class="modal-overlay hidden"><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h1 class="text-3xl font-bold mb-4 text-emerald-300">æ­¡è¿ä¾†åˆ°å¿ƒæµOS</h1><p class="text-gray-300 mb-6">ä½ çš„å°ˆæ³¨åŠ›ï¼Œå°‡æœƒçŒæº‰ä¸€æ ªå°æ¨¹è‹—ï¼Œè®“å®ƒèŒå£¯æˆé•·ã€‚</p><form id="onboarding-form"><label for="plant-name-input" class="block mb-2 font-semibold">ç‚ºä½ çš„æ¤ç‰©å¤¥ä¼´å–å€‹åå­—å§ï¼</label><input type="text" id="plant-name-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ä¾‹å¦‚ï¼šå°ç¶ " required><button type="submit" class="btn-primary w-full">é–‹å§‹ç¨®æ¤</button></form></div></div>
        <div id="settings-modal" class="modal-overlay hidden"><div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col max-h-[90vh]"><div class="p-6 border-b border-gray-700 flex justify-between items-center"><h2 class="text-2xl font-bold">è¨­å®š</h2><button id="close-settings-button" class="text-gray-400 hover:text-white text-3xl">&times;</button></div><div class="p-6 space-y-4 overflow-y-auto"><div><label for="focus-duration-input" class="block mb-2 font-semibold">å°ˆæ³¨æ™‚é–“ (åˆ†é˜)</label><input type="number" id="focus-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="break-duration-input" class="block mb-2 font-semibold">ä¼‘æ¯æ™‚é–“ (åˆ†é˜)</label><input type="number" id="break-duration-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" min="1"></div><div><label for="blocked-sites-input" class="block mb-2 font-semibold">åˆ†å¿ƒç¶²ç«™æ¸…å–®</label><textarea id="blocked-sites-input" rows="3" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="e.g., youtube.com"></textarea></div></div><div class="p-6 border-t border-gray-700"><button id="save-settings-button" class="btn-primary w-full text-lg py-3">å„²å­˜è¨­å®š</button></div></div></div>
        <div id="reminder-modal" class="modal-overlay hidden opacity-0"><div class="bg-blue-900 border-2 border-blue-500 p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center"><h3 class="text-2xl font-bold text-white mb-4">å°ˆæ³¨æ™‚é–“ï¼</h3><p id="reminder-text" class="text-blue-200"></p></div></div>
        
        <!-- v2.3 æ–°å¢: æ–°å¢/ç·¨è¼¯ç¿’æ…£å½ˆçª— -->
        <div id="habit-modal" class="modal-overlay hidden">
             <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm flex flex-col">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 id="habit-modal-title" class="text-2xl font-bold">æ–°å¢ç¿’æ…£</h2>
                    <button id="close-habit-modal-button" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                </div>
                <form id="habit-form" class="p-6 space-y-4">
                    <input type="hidden" id="habit-id-input">
                    <div><label for="habit-name-input" class="block mb-2 font-semibold">ç¿’æ…£åç¨±</label><input type="text" id="habit-name-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="ä¾‹å¦‚ï¼šæ¯æ—¥é–±è®€" required></div>
                    <div><label for="habit-icon-input" class="block mb-2 font-semibold">é¸æ“‡åœ–ç¤º</label><input type="text" id="habit-icon-input" class="w-full px-4 py-3 bg-gray-700 text-white rounded-lg" placeholder="ä¾‹å¦‚ï¼šğŸ“š (å¯è¼¸å…¥ Emoji)"></div>
                </form>
                <div class="p-6 border-t border-gray-700 flex flex-col space-y-2">
                    <button id="save-habit-button" class="bg-emerald-600 hover:bg-emerald-700 text-white w-full text-lg py-3 rounded-lg">å„²å­˜ç¿’æ…£</button>
                    <button id="delete-habit-button" class="bg-red-800 hover:bg-red-700 text-white w-full text-center py-2 rounded-lg hidden">åˆªé™¤ç¿’æ…£</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-notification"><span id="toast-text"></span></div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ & DOM é¸æ“‡ (v2.3 æ›´æ–°) ---
        const DOMElements = {
            pages: document.querySelectorAll('main > div'),
            navButtons: document.querySelectorAll('.nav-item'),
            gardenPage: document.getElementById('garden-page'),
            dashboardPage: document.getElementById('dashboard-page'),
            achievementsPage: document.getElementById('achievements-page'),
            habitsPage: document.getElementById('habits-page'), // æ–°å¢
            plantSvg: document.getElementById('plant-svg'),
            plantBody: document.getElementById('plant-body'),
            plantRareFeature: document.getElementById('plant-rare-feature'),
            plantName: document.getElementById('plant-name'),
            timerDisplay: document.getElementById('timer-display'),
            progressBar: document.getElementById('progress-bar'),
            startButton: document.getElementById('start-button'),
            distractedButton: document.getElementById('distracted-button'),
            sessionCount: document.getElementById('session-count'),
            onboardingModal: document.getElementById('onboarding-modal'),
            onboardingForm: document.getElementById('onboarding-form'),
            plantNameInput: document.getElementById('plant-name-input'),
            settingsButton: document.getElementById('settings-button'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsButton: document.getElementById('close-settings-button'),
            saveSettingsButton: document.getElementById('save-settings-button'),
            focusDurationInput: document.getElementById('focus-duration-input'),
            breakDurationInput: document.getElementById('break-duration-input'),
            blockedSitesInput: document.getElementById('blocked-sites-input'),
            statsTotalTime: document.getElementById('stats-total-time'),
            statsTotalSessions: document.getElementById('stats-total-sessions'),
            statsLongestStreak: document.getElementById('stats-longest-streak'),
            focusChartCanvas: document.getElementById('focus-chart'),
            achievementsGrid: document.getElementById('achievements-grid'),
            // ç¿’æ…£ç›¸é—œ DOM (æ–°å¢)
            habitsList: document.getElementById('habits-list'),
            addHabitButton: document.getElementById('add-habit-button'),
            habitModal: document.getElementById('habit-modal'),
            habitModalTitle: document.getElementById('habit-modal-title'),
            closeHabitModalButton: document.getElementById('close-habit-modal-button'),
            habitForm: document.getElementById('habit-form'),
            habitIdInput: document.getElementById('habit-id-input'),
            habitNameInput: document.getElementById('habit-name-input'),
            habitIconInput: document.getElementById('habit-icon-input'),
            saveHabitButton: document.getElementById('save-habit-button'),
            deleteHabitButton: document.getElementById('delete-habit-button'),
            // Toast
            toast: document.getElementById('toast-notification'),
            toastText: document.getElementById('toast-text'),
        };
        let state = {}, focusChart = null;

        // --- ç‹€æ…‹ç®¡ç† (v2.3 æ›´æ–°) ---
        function resetState() {
            state = {
                mode: 'idle',
                timerId: null,
                totalTime: 25 * 60,
                timeLeft: 25 * 60,
                plantName: '',
                growthLevel: 0,
                rareFeature: null,
                settings: { focusDuration: 25, breakDuration: 5, blockedSites: [] },
                focusHistory: [],
                achievements: [],
                habits: [], // æ–°å¢ state.habits
            };
        }
        function saveData() { localStorage.setItem('flowOSState_v2.3', JSON.stringify(state)); }
        function loadData() {
            const savedData = JSON.parse(localStorage.getItem('flowOSState_v2.3'));
            if (savedData) {
                Object.assign(state, savedData);
                if (!state.focusHistory) state.focusHistory = [];
                if (!state.achievements) state.achievements = [];
                if (!state.habits) state.habits = []; // ç¢ºä¿èˆŠç”¨æˆ¶ä¹Ÿèƒ½æœ‰ habits é™£åˆ—
                return true;
            }
            return false;
        }

        // --- éŸ³æ•ˆ (v2.3 æ›´æ–°) ---
        const synth = new Tone.Synth().toDestination();
        const sounds = {
            success: () => synth.triggerAttackRelease("C5", "8n", Tone.now()),
            start: () => synth.triggerAttackRelease("C4", "8n", Tone.now()),
            save: () => synth.triggerAttackRelease("E5", "8n", Tone.now()),
            achievement: () => synth.triggerAttackRelease("G5", "4n", Tone.now()),
            check: () => synth.triggerAttackRelease("A5", "8n", Tone.now()), // æ–°å¢æ‰“å¡éŸ³æ•ˆ
        };

        // --- ä¿®å¾©: æ–°å¢ plantStages å’Œ rareFeaturesSVG çš„å®šç¾© ---
        const plantStages = [
            `<path d="M100 210 L100 180" stroke="#73b865" stroke-width="4"/>`,
            `<path d="M100 210 L100 170" stroke="#73b865" stroke-width="5"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/>`,
            `<path d="M100 210 L100 160" stroke="#73b865" stroke-width="6"/><path d="M100 180 C 80 170, 80 150, 100 140" stroke="#84cc76" stroke-width="4" fill="none"/><path d="M100 175 C 120 165, 120 145, 100 135" stroke="#84cc76" stroke-width="4" fill="none"/>`,
            `<path d="M100 210 L100 140" stroke="#73b865" stroke-width="7"/><path d="M100 170 C 60 150, 60 120, 100 120" stroke="#84cc76" stroke-width="5" fill="none"/><path d="M100 165 C 140 145, 140 115, 100 115" stroke="#84cc76" stroke-width="5" fill="none"/>`,
            `<path d="M100 210 L100 135" stroke="#6a9a5f" stroke-width="8"/><path d="M100 170 C 60 150, 60 120, 100 120" stroke="#84cc76" stroke-width="5" fill="none"/><path d="M100 165 C 140 145, 140 115, 100 115" stroke="#84cc76" stroke-width="5" fill="none"/><circle cx="100" cy="105" r="15" fill="#fde047"/><circle cx="100" cy="105" r="8" fill="#fca5a5"/>`
        ];
        const rareFeaturesSVG = {
            'gold_flower': `<circle cx="130" cy="140" r="10" fill="gold" stroke="white" stroke-width="2"/>`,
            'blue_leaf': `<path d="M100 190 C 120 180, 120 160, 100 150" stroke="#3b82f6" stroke-width="4" fill="none"/>`,
            'crystal_fruit': `<circle cx="70" cy="150" r="12" fill="cyan" opacity="0.7"/>`
        };


        // --- æˆå°±ç³»çµ± (v2.3 æ›´æ–°) ---
        const ACHIEVEMENT_CONFIG = {
            focus_1: { title: "å°ˆæ³¨æ–°æ‰‹", desc: "å®Œæˆç¬¬ 1 æ¬¡å°ˆæ³¨", icon: "ğŸŒ±", check: s => s.growthLevel >= 1 },
            focus_10: { title: "å°ˆæ³¨é”äºº", desc: "å®Œæˆ 10 æ¬¡å°ˆæ³¨", icon: "ğŸŒ³", check: s => s.growthLevel >= 10 },
            habit_1: { title: "æ–°é–‹å§‹", desc: "å»ºç«‹ç¬¬ä¸€å€‹ç¿’æ…£", icon: "ğŸ“", check: s => s.habits.length >= 1 }, // æ–°å¢
            habit_streak_3: { title: "é¤Šæˆä¸­", desc: "ä»»ä¸€ç¿’æ…£é€£çºŒæ‰“å¡ 3 å¤©", icon: "ğŸ”¥", check: s => s.habits.some(h => getHabitStreak(h) >= 3) }, // æ–°å¢
            time_60: { title: "ä¸€å°æ™‚æˆå°±", desc: "ç´¯è¨ˆå°ˆæ³¨ 60 åˆ†é˜", icon: "â±ï¸", check: s => calculateTotalFocusTime(s) >= 60 },
            streak_7: { title: "ä¸€é€±æŒ‘æˆ°", desc: "é€£çºŒå°ˆæ³¨ 7 å¤©", icon: "ğŸ¥ˆ", check: s => calculateLongestStreak(s.focusHistory) >= 7 },
            rare_1: { title: "ç¨€æœ‰ç™¼ç¾", desc: "ç™¼ç¾ç¬¬ä¸€å€‹ç¨€æœ‰ç‰¹å¾µ", icon: "ğŸ’", check: s => !!s.rareFeature },
        };
        
        // --- ç¿’æ…£æ‰“å¡åŠŸèƒ½ (v2.3 æ–°å¢) ---
        function getHabitStreak(habit) {
            if (!habit.checkIns || habit.checkIns.length === 0) return 0;
            const sortedCheckIns = [...new Set(habit.checkIns)].sort().reverse();
            
            const today = new Date();
            const firstCheckIn = new Date(sortedCheckIns[0]);
            
            const diffFromToday = (today - firstCheckIn) / (1000 * 3600 * 24);
            if(Math.floor(diffFromToday) > 1) return 0;
            if(Math.floor(diffFromToday) === 1 && today.getHours() < firstCheckIn.getHours()) return 0;


            let streak = 0;
            if (Math.floor(diffFromToday) <= 1) {
                streak = 1;
            } else {
                return 0;
            }

            for (let i = 1; i < sortedCheckIns.length; i++) {
                const current = new Date(sortedCheckIns[i-1]);
                const previous = new Date(sortedCheckIns[i]);
                const diff = (current - previous) / (1000 * 3600 * 24);
                if (diff === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function renderHabitsPage() {
            DOMElements.habitsList.innerHTML = '';
            if (state.habits.length === 0) {
                DOMElements.habitsList.innerHTML = `<p class="text-center text-gray-400">å°šæœªå»ºç«‹ä»»ä½•ç¿’æ…£ã€‚é»æ“Šå³ä¸Šè§’æ–°å¢ä¸€å€‹å§ï¼</p>`;
                return;
            }
            state.habits.forEach(habit => {
                const habitEl = document.createElement('div');
                habitEl.className = 'habit-item';
                habitEl.dataset.habitId = habit.id;

                const todayStr = new Date().toISOString().split('T')[0];
                const isCheckedToday = habit.checkIns && habit.checkIns.includes(todayStr);
                const currentStreak = getHabitStreak(habit);
                
                habitEl.innerHTML = `
                    <div class="flex-grow flex items-center cursor-pointer habit-info">
                        <span class="text-3xl mr-4">${habit.icon || 'ğŸ¯'}</span>
                        <div>
                            <span class="text-lg font-semibold">${habit.name}</span>
                            ${currentStreak > 0 ? `<span class="ml-2 text-orange-400 font-bold">ğŸ”¥ ${currentStreak}</span>` : ''}
                        </div>
                    </div>
                    <button data-habit-id="${habit.id}" class="habit-check-button ${isCheckedToday ? 'checked' : 'pending'}">
                        ${isCheckedToday ? 'âœ”' : ''}
                    </button>
                `;
                DOMElements.habitsList.appendChild(habitEl);
            });
        }

        function handleHabitCheckIn(habitId) {
            const habit = state.habits.find(h => h.id === habitId);
            if (!habit) return;
            
            const todayStr = new Date().toISOString().split('T')[0];
            if (!habit.checkIns) habit.checkIns = [];

            const index = habit.checkIns.indexOf(todayStr);
            if (index > -1) {
                habit.checkIns.splice(index, 1);
            } else {
                habit.checkIns.push(todayStr);
            }

            sounds.check();
            saveData();
            renderHabitsPage();
            checkAchievements();
        }

        function openHabitModal(habit = null) {
            DOMElements.habitForm.reset();
            if (habit) {
                DOMElements.habitModalTitle.textContent = "ç·¨è¼¯ç¿’æ…£";
                DOMElements.habitIdInput.value = habit.id;
                DOMElements.habitNameInput.value = habit.name;
                DOMElements.habitIconInput.value = habit.icon;
                DOMElements.deleteHabitButton.classList.remove('hidden');
            } else {
                DOMElements.habitModalTitle.textContent = "æ–°å¢ç¿’æ…£";
                DOMElements.habitIdInput.value = '';
                DOMElements.deleteHabitButton.classList.add('hidden');
            }
            DOMElements.habitModal.classList.remove('hidden');
        }

        function saveHabit() {
            const id = DOMElements.habitIdInput.value;
            const name = DOMElements.habitNameInput.value.trim();
            const icon = DOMElements.habitIconInput.value.trim();
            if (!name) return;

            if (id) {
                const existingHabit = state.habits.find(h => h.id === id);
                if(existingHabit) {
                    existingHabit.name = name;
                    existingHabit.icon = icon;
                }
            } else {
                state.habits.push({ id: `h_${Date.now()}`, name, icon, checkIns: [] });
            }
            saveData();
            renderHabitsPage();
            DOMElements.habitModal.classList.add('hidden');
            checkAchievements();
        }

        function deleteHabit() {
            const id = DOMElements.habitIdInput.value;
            state.habits = state.habits.filter(h => h.id !== id);
            saveData();
            renderHabitsPage();
            DOMElements.habitModal.classList.add('hidden');
        }

        function switchPage(pageId) {
            DOMElements.pages.forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            DOMElements.navButtons.forEach(b => {
                b.classList.toggle('active', b.dataset.page === pageId);
            });
            
            if (pageId === 'dashboard-page') renderDashboard();
            if (pageId === 'achievements-page') renderAchievements();
            if (pageId === 'habits-page') renderHabitsPage();
        }

        function init() {
            resetState();
            if (loadData()) {
                DOMElements.onboardingModal.classList.add('hidden');
            } else {
                DOMElements.onboardingModal.classList.remove('hidden');
            }
            state.timeLeft = state.settings.focusDuration * 60;
            updatePlantVisuals();
            updateTimerDisplay();
            switchPage('garden-page');
        }
        
        function checkAchievements(){Object.keys(ACHIEVEMENT_CONFIG).forEach(e=>{state.achievements.includes(e)||ACHIEVEMENT_CONFIG[e].check(state)&&(state.achievements.push(e),showToast(`å¾½ç« å·²è§£é–ï¼š${ACHIEVEMENT_CONFIG[e].title}`),sounds.achievement())})}
        function renderAchievements(){DOMElements.achievementsGrid.innerHTML="",Object.keys(ACHIEVEMENT_CONFIG).forEach(e=>{const t=ACHIEVEMENT_CONFIG[e],c=state.achievements.includes(e),n=document.createElement("div");n.className=`achievement-badge ${c?"unlocked":"locked"}`,n.innerHTML=`<div class="achievement-icon">${t.icon}</div><h3 class="font-bold">${t.title}</h3><p class="text-xs text-gray-400">${t.desc}</p>`,DOMElements.achievementsGrid.appendChild(n)})}
        function calculateTotalFocusTime(e){return e.focusHistory.reduce((e,t)=>e+t.duration,0)}
        function calculateLongestStreak(e){if(0===e.length)return 0;const t=[...new Set(e.map(e=>e.date))].sort();if(0===t.length)return 0;let c=1,n=1;for(let e=1;e<t.length;e++){const s=new Date(t[e]),o=new Date(t[e-1]);1===(s-o)/864e5?n++:(c=Math.max(c,n),n=1)}return Math.max(c,n)}
        function renderDashboard(){DOMElements.statsTotalTime.textContent=calculateTotalFocusTime(state),DOMElements.statsTotalSessions.textContent=state.growthLevel,DOMElements.statsLongestStreak.textContent=calculateLongestStreak(state.focusHistory);const e={};for(let t=6;t>=0;t--){const c=new Date;c.setDate(c.getDate()-t),e[c.toISOString().split("T")[0]]=0}state.focusHistory.forEach(t=>{void 0!==e[t.date]&&(e[t.date]+=t.duration)});const t=Object.keys(e).map(e=>e.substring(5)),c=Object.values(e);focusChart&&focusChart.destroy(),focusChart=new Chart(DOMElements.focusChartCanvas,{type:"bar",data:{labels:t,datasets:[{label:"å°ˆæ³¨æ™‚é•· (åˆ†é˜)",data:c,backgroundColor:"rgba(52, 211, 153, 0.5)",borderColor:"rgba(16, 185, 129, 1)",borderWidth:1,borderRadius:5}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,grid:{color:"rgba(255,255,255,0.1)"}},x:{grid:{color:"rgba(255,255,255,0.1)"}}},plugins:{legend:{display:!1}}}})}
        function handleFocusComplete(){const e=state.settings.focusDuration;state.growthLevel++;const t=new Date().toISOString().split("T")[0];state.focusHistory.push({date:t,duration:e}),checkAchievements(),Math.random()<.2&&!state.rareFeature&&(state.rareFeature=Object.keys(rareFeaturesSVG)[Math.floor(Math.random()*Object.keys(rareFeaturesSVG).length)]),saveData(),updatePlantVisuals(),DOMElements.plantSvg.classList.add("plant-grow"),setTimeout(()=>DOMElements.plantSvg.classList.remove("plant-grow"),500),startTimer("break")}
        function showToast(e){DOMElements.toastText.textContent=e,DOMElements.toast.classList.add("show"),setTimeout(()=>DOMElements.toast.classList.remove("show"),3e3)}
        function updateTimerDisplay(){const e=Math.floor(state.timeLeft/60).toString().padStart(2,"0"),t=(state.timeLeft%60).toString().padStart(2,"0"),c=`${e}:${t}`;DOMElements.timerDisplay.textContent=c,document.title=`${c} - å¿ƒæµOS`}
        function startTimer(e){if(state.timerId)clearInterval(state.timerId);state.mode=e;const t="focus"===e?state.settings.focusDuration:state.settings.breakDuration;state.totalTime=60*t,state.timeLeft=state.totalTime,updateTimerDisplay(),DOMElements.progressBar.style.width="0%","focus"===e?(sounds.start(),DOMElements.startButton.textContent="å°ˆæ³¨ä¸­...",DOMElements.startButton.disabled=!0,DOMElements.distractedButton.classList.remove("hidden")):(sounds.success(),DOMElements.startButton.textContent=`ä¼‘æ¯ä¸€ä¸‹ (${state.settings.breakDuration}:00)`,DOMElements.startButton.disabled=!0,DOMElements.distractedButton.classList.add("hidden")),state.timerId=setInterval(tick,1e3)}
        function tick(){state.timeLeft--;updateTimerDisplay();const e=state.totalTime>0?(state.totalTime-state.timeLeft)/state.totalTime*100:0;DOMElements.progressBar.style.width=`${e}%`,state.timeLeft<=0&&(clearInterval(state.timerId),state.timerId=null,"focus"===state.mode?handleFocusComplete():handleBreakComplete())}
        function handleBreakComplete(){state.mode="idle",DOMElements.startButton.textContent="é–‹å§‹ä¸‹ä¸€å€‹å°ˆæ³¨",DOMElements.startButton.disabled=!1,DOMElements.progressBar.style.width="0%",state.timeLeft=60*state.settings.focusDuration,updateTimerDisplay(),document.title="å¿ƒæµOS"}
        function handleDistraction(){if("focus"!==state.mode||state.timeLeft<=10)return;DOMElements.plantSvg.classList.add("plant-wilt"),setTimeout(()=>DOMElements.plantSvg.classList.remove("plant-wilt"),500),state.timeLeft=Math.max(0,state.timeLeft-30);const e=DOMElements.distractedButton.textContent;DOMElements.distractedButton.textContent="æ²’é—œä¿‚ï¼Œæˆ‘å€‘ç¹¼çºŒï¼",DOMElements.distractedButton.disabled=!0,setTimeout(()=>{DOMElements.distractedButton.textContent=e,DOMElements.distractedButton.disabled=!1},2e3)}
        function updatePlantVisuals(){const e=Math.min(Math.floor(state.growthLevel/2),plantStages.length-1);DOMElements.plantBody.innerHTML=plantStages[e]||plantStages[0],DOMElements.plantName.textContent=state.plantName,DOMElements.sessionCount.textContent=state.growthLevel,DOMElements.plantRareFeature.innerHTML=state.rareFeature?rareFeaturesSVG[state.rareFeature]:"",DOMElements.plantSvg.style.transform=`scale(${1+state.growthLevel*.015})`}

        DOMElements.navButtons.forEach(e=>{e.addEventListener("click",()=>switchPage(e.dataset.page))});
        DOMElements.onboardingForm.addEventListener("submit",e=>{e.preventDefault(),state.plantName=DOMElements.plantNameInput.value.trim(),state.plantName&&(DOMElements.onboardingModal.classList.add("hidden"),saveData(),updatePlantVisuals())});
        DOMElements.startButton.addEventListener("click",()=>"idle"===state.mode&&startTimer("focus"));
        DOMElements.distractedButton.addEventListener("click",handleDistraction);
        DOMElements.settingsButton.addEventListener("click",()=>{DOMElements.focusDurationInput.value=state.settings.focusDuration,DOMElements.breakDurationInput.value=state.settings.breakDuration,DOMElements.blockedSitesInput.value=(state.settings.blockedSites||[]).join("\n"),DOMElements.settingsModal.classList.remove("hidden")});
        DOMElements.closeSettingsButton.addEventListener("click",()=>DOMElements.settingsModal.classList.add("hidden"));
        DOMElements.saveSettingsButton.addEventListener("click",()=>{state.settings.focusDuration=parseInt(DOMElements.focusDurationInput.value,10)||25,state.settings.breakDuration=parseInt(DOMElements.breakDurationInput.value,10)||5,state.settings.blockedSites=(DOMElements.blockedSitesInput.value||"").split("\n").map(e=>e.trim()).filter(Boolean),"idle"===state.mode&&(state.timeLeft=60*state.settings.focusDuration,updateTimerDisplay()),saveData(),sounds.save(),DOMElements.settingsModal.classList.add("hidden")});
        
        init();
    </script>
</body>
</html>
