<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貓芯 CatCore (Static Demo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@0.395.0/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .card {
            @apply bg-white border border-stone-200/80 rounded-2xl shadow-sm hover:shadow-md transition-shadow duration-300;
        }
        .btn-primary {
            @apply bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 disabled:bg-stone-300 disabled:cursor-not-allowed;
        }
        .btn-secondary {
            @apply bg-stone-200 hover:bg-stone-300 text-stone-700 font-bold py-2 px-4 rounded-lg transition-colors duration-300;
        }
        .page-title {
            @apply text-3xl font-bold text-stone-800 mb-2;
        }
        .page-subtitle {
            @apply text-lg text-stone-500 mb-8;
        }
    </style>
</head>
<body class="bg-orange-50/50 text-stone-800">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                <a href="#" data-page="home" class="nav-link flex items-center gap-2 text-xl font-bold text-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-paw-print"><circle cx="11" cy="4" r="2"/><circle cx="18" cy="8" r="2"/><circle cx="4" cy="8" r="2"/><path d="M9 10c0 2.5-2 2.5-2 5"/><path d="M15 10c0 2.5 2 2.5 2 5"/><path d="M11 14c0 2.5 2 2.5 2 5"/><path d="M7 19.5c.5.5 1.5.5 2 0"/><path d="M15 19.5c-.5.5-1.5.5-2 0"/></svg>
                    <span>貓芯</span>
                </a>
                <div class="hidden md:flex items-center gap-6 text-stone-600">
                    <a href="#" data-page="cats" class="nav-link hover:text-orange-500">貓咪名錄</a>
                    <a href="#" data-page="subscribe" class="nav-link hover:text-orange-500">遠端領養</a>
                    <a href="#" data-page="experience" class="nav-link hover:text-orange-500">在地體驗</a>
                    <a href="#" data-page="blindbox" class="nav-link hover:text-orange-500">盲盒專區</a>
                    <a href="#" data-page="transparency" class="nav-link hover:text-orange-500">透明儀表板</a>
                </div>
                <div id="auth-section" class="flex items-center gap-2">
                    <!-- Role switcher will be rendered here -->
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            
            <!-- Home Page -->
            <section id="page-home" class="page active">
                <div class="space-y-16">
                    <section class="text-center py-12 bg-orange-100/50 rounded-3xl">
                        <h1 class="text-4xl md:text-5xl font-bold text-orange-600 mb-4">貓芯 CatCore</h1>
                        <p class="text-xl text-stone-600 max-w-3xl mx-auto">
                            一個以動物福利為核心的永續互動平台。我們相信，愛與尊重，可以透過科技傳遞得更遠。
                        </p>
                    </section>
                    <section>
                        <h2 class="text-3xl font-bold text-center mb-10">三大主軸</h2>
                        <div class="grid md:grid-cols-3 gap-8">
                           <!-- Pillar Cards will be rendered here -->
                        </div>
                    </section>
                    <section>
                        <h2 class="text-3xl font-bold text-center mb-10">透明指標概覽</h2>
                        <div id="kpi-overview-container"></div>
                    </section>
                    <section>
                         <h2 class="text-3xl font-bold text-center mb-10">最新動態</h2>
                         <div id="latest-posts-container" class="grid md:grid-cols-3 gap-6"></div>
                    </section>
                </div>
            </section>

            <!-- Cats List Page -->
            <section id="page-cats" class="page">
                <div>
                    <h1 class="page-title">貓咪名錄</h1>
                    <p class="page-subtitle">認識一下我們每一位可愛的成員。點擊卡片查看牠們的詳細故事。</p>
                </div>
                <div id="cats-list-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Cat cards will be rendered here -->
                </div>
            </section>

            <!-- Cat Profile Page -->
            <section id="page-cat-profile" class="page">
                <!-- Cat profile will be rendered here -->
            </section>
            
            <!-- Imprint Station Page -->
            <section id="page-imprints-new" class="page">
                 <!-- Imprint station will be rendered here. Needs auth. -->
            </section>
            
            <!-- Blindbox Page -->
            <section id="page-blindbox" class="page">
                <!-- Blindbox content will be rendered here -->
            </section>
            
            <!-- Subscribe Page -->
            <section id="page-subscribe" class="page">
                <!-- Subscribe content will be rendered here -->
            </section>

            <!-- Experience Page -->
            <section id="page-experience" class="page">
                <!-- Experience content will be rendered here -->
            </section>

            <!-- Transparency Page -->
            <section id="page-transparency" class="page">
                <!-- Transparency dashboard will be rendered here -->
            </section>
        </main>
        
        <!-- Footer -->
        <footer class="bg-stone-100 border-t mt-auto">
            <div class="container mx-auto px-4 py-6 text-center text-stone-500">
                <p>&copy; <span id="footer-year"></span> 貓芯 CatCore. All Rights Reserved.</p>
                <p class="text-sm mt-2">這是一個基於動物福利為核心的靜態演示專案，不涉及任何真實交易。</p>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // 1. MOCK DATABASE (All data is stored here)
            // =================================================================
            const db = {
                cats: [
                    { id: 1, name: '花花', code: 'HANA-001', sex: 'F', age: 2, status: 'SHELTER', story: '從花園裡發現的親人小美女，喜歡曬太陽和追逐光影。', coverImage: 'https://images.pexels.com/photos/1170986/pexels-photo-1170986.jpeg?auto=compress&cs=tinysrgb&w=600' },
                    { id: 2, name: '斑斑', code: 'BAN-002', sex: 'M', age: 3, status: 'SHELTER', story: '有點害羞的帥氣虎斑貓，需要多一點耐心來融化他的心。', coverImage: 'https://images.pexels.com/photos/1056251/pexels-photo-1056251.jpeg?auto=compress&cs=tinysrgb&w=600' },
                    { id: 3, name: '橘寶', code: 'JU-003', sex: 'M', age: 5, status: 'LONGSTAY', story: '體型圓潤的橘貓大叔，因為有慢性口炎需要長期照顧。', coverImage: 'https://images.pexels.com/photos/2071873/pexels-photo-2071873.jpeg?auto=compress&cs=tinysrgb&w=600' },
                    { id: 4, name: '咪咪', code: 'MIMI-004', sex: 'F', age: 1, status: 'ADOPTED', story: '活潑好動的小貓，已經在 2024 年 8 月找到永遠的家。', coverImage: 'https://images.pexels.com/photos/45201/kitty-cat-kitten-pet-45201.jpeg?auto=compress&cs=tinysrgb&w=600' }
                ],
                stressLogs: [
                    { id: 1, catId: 1, level: 'G', notes: '精神食慾良好，主動討摸。', recordedBy: 'VOLUNTEER', createdAt: new Date().toISOString() },
                    { id: 2, catId: 2, level: 'Y', notes: '對新環境稍有警戒，躲在角落。', recordedBy: 'VOLUNTEER', createdAt: new Date().toISOString() },
                    { id: 3, catId: 3, level: 'R', notes: '口炎疼痛，情緒不穩，已由獸醫處理。', recordedBy: 'VOLUNTEER', createdAt: new Date().toISOString() },
                    { id: 4, catId: 4, level: 'G', notes: '在新家適應良好。', recordedBy: 'ADMIN', createdAt: new Date('2024-08-15').toISOString() },
                    // Fake historical data for cat 1
                    { id: 5, catId: 1, level: 'Y', notes: '剛入所，比較緊張', createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()},
                    { id: 6, catId: 1, level: 'Y', notes: '開始探索環境', createdAt: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString()},
                    { id: 7, catId: 1, level: 'G', notes: '願意接受撫摸', createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString()},
                    { id: 8, catId: 1, level: 'G', notes: '主動蹭人', createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()},
                ],
                imprintSessions: [
                    { id: 1, catId: 1, startedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), durationSeconds: 8, allowed: true, method: 'LIVE', traceId: 'IMP-171555-1' },
                ],
                blindboxRules: [
                    { season: '2025-Q3-PAW', ratios: { 'HANA-001': 0.7, 'BAN-002': 0.3 }, stopOnAdopt: true },
                ],
                blindboxStops: [
                    { catId: 4, stoppedAt: new Date('2024-08-14').toISOString(), reason: 'adopted' },
                ],
                kpiSnapshot: {
                    asOfDate: new Date().toISOString(), adoptionRate: 0.25, avgWaitDays: 180.5, onTimeReportRate: 0.98, contentToSalesRatio: 3.2, medicalCoverageRate: 0.85, overworkRedSessions: 0,
                },
                contentPosts: [
                    { id: 1, title: '如何觀察貓咪的壓力訊號？', short: '從耳朵、尾巴到叫聲，教你讀懂貓主子的情緒...', category: 'EDUCATION', publishedAt: new Date().toISOString() },
                    { id: 2, title: '花花的一天：陽光與貓薄荷', short: '跟隨我們的鏡頭，看看花花在收容所的日常生活...', catId: 1, category: 'STORY', publishedAt: new Date().toISOString() },
                    { id: 3, title: '八月份財務報告與支出憑證', short: '本月總收入、支出細項與所有憑證雜湊列表。', category: 'TRANSPARENCY', publishedAt: new Date().toISOString() },
                ],
                receipts: [
                    { id: 1, kind: 'medical', amountTwd: 3500.0, date: new Date().toISOString(), vendor: '核心動物醫院', hash: '0x' + Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b => b.toString(16).padStart(2, '0')).join('') },
                    { id: 2, kind: 'food', amountTwd: 5200.0, date: new Date().toISOString(), vendor: '寵物好事多', hash: '0x' + Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b => b.toString(16).padStart(2, '0')).join('') },
                ],
                experienceSlots: [
                    { id: 1, siteCode: 'TPE', date: new Date('2025-09-13T14:00:00.000+08:00'), startTime: '14:00', endTime: '15:00', capacity: 6, bookedCount: 4, insuranceNo: 'INS-TPE-20250913', vetOnSite: true },
                    { id: 2, siteCode: 'TXG', date: new Date('2025-09-14T15:00:00.000+08:00'), startTime: '15:00', endTime: '16:00', capacity: 6, bookedCount: 6, insuranceNo: 'INS-TXG-20250914', vetOnSite: true },
                ],
                 subscriptionPlans: [
                    { id: 1, name: '週方案', cadenceDays: 7, priceTwd: 250 },
                    { id: 2, name: '雙週方案', cadenceDays: 14, priceTwd: 450 },
                    { id: 3, name: '月方案', cadenceDays: 30, priceTwd: 800 },
                ],
            };
            
            // =================================================================
            // 2. APPLICATION STATE
            // =================================================================
            const appState = {
                currentPage: 'home',
                currentUserRole: 'USER', // 'USER', 'VOLUNTEER', 'ADMIN'
                selectedCatId: null,
            };

            // =================================================================
            // 3. UTILITY & COMPONENT RENDER FUNCTIONS
            // =================================================================
            
            const getCatWithStress = (catId) => {
                const cat = db.cats.find(c => c.id === catId);
                if (!cat) return null;
                const stressLogs = db.stressLogs.filter(log => log.catId === cat.id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                return { ...cat, stressLogs };
            };

            const createIcon = (name, className = 'w-5 h-5') => `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-${name} ${className}"><use href="https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/${name}.svg#${name}"></use></svg>`;
            
            const createStressChip = (level, large = false) => {
                const levelMap = {
                    G: { text: 'G / 良好', className: 'bg-green-100 text-green-800 border-green-200' },
                    Y: { text: 'Y / 輕微壓力', className: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
                    R: { text: 'R / 明顯壓力', className: 'bg-red-100 text-red-800 border-red-200' },
                };
                const details = level ? levelMap[level] : { text: 'N/A', className: 'bg-stone-100 text-stone-800 border-stone-200' };
                const sizeClass = large ? 'px-4 py-1.5 text-base' : 'px-3 py-1 text-xs';
                return `<span class="font-medium rounded-full border ${sizeClass} ${details.className}">${details.text}</span>`;
            };

            const createCatCard = (cat) => {
                const latestStress = db.stressLogs.filter(log => log.catId === cat.id).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
                const statusMap = { 'SHELTER': '收容中', 'FOSTER': '中途之家', 'ADOPTED': '已送養', 'LONGSTAY': '長期照護' };
                const statusColor = cat.status === 'ADOPTED' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800';

                return `
                    <a href="#" data-page="cat-profile" data-cat-id="${cat.id}" class="cat-card-link card block group">
                        <div class="relative h-60 w-full overflow-hidden rounded-t-2xl">
                            <img src="${cat.coverImage}" alt="" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start">
                                <div><h2 class="text-2xl font-bold">${cat.name}</h2><p class="text-sm text-stone-500">#${cat.code}</p></div>
                                ${createStressChip(latestStress?.level)}
                            </div>
                            <p class="text-stone-600 mt-4 h-20 overflow-hidden text-ellipsis">${cat.story}</p>
                            <div class="mt-4 pt-4 border-t flex justify-between items-center text-sm text-stone-500">
                                <span>${cat.sex === 'M' ? '男生' : '女生'}・${cat.age} 歲</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusMap[cat.status]}</span>
                            </div>
                        </div>
                    </a>`;
            };
            
            // =================================================================
            // 4. PAGE RENDERING LOGIC
            // =================================================================

            function renderHomePage() {
                // Render Pillar Cards
                const pillarContainer = document.querySelector('#page-home .grid');
                pillarContainer.innerHTML = `
                    <div class="card p-8 text-center flex flex-col items-center">
                        <div class="mb-4">${createIcon('paw-print', 'w-12 h-12 text-orange-500')}</div>
                        <h3 class="text-2xl font-bold mb-3">狗採橘子</h3>
                        <p class="text-stone-600 mb-6 flex-grow">將貓咪的自然行為轉化為獨一無二的「印記商品」，嚴格限制在無壓力狀態下進行，全程透明、可追溯。</p>
                        <a href="#" data-page="blindbox" class="nav-link btn-secondary w-full">了解印記商品</a>
                    </div>
                    <div class="card p-8 text-center flex flex-col items-center">
                        <div class="mb-4">${createIcon('heart-handshake', 'w-12 h-12 text-teal-500')}</div>
                        <h3 class="text-2xl font-bold mb-3">遠端領養</h3>
                        <p class="text-stone-600 mb-6 flex-grow">透過訂閱制長期關懷特定貓咪，定期收取專屬報告。您的支持是他們最穩定的依靠。</p>
                        <a href="#" data-page="subscribe" class="nav-link btn-secondary w-full">開始遠端領養</a>
                    </div>
                    <div class="card p-8 text-center flex flex-col items-center">
                        <div class="mb-4">${createIcon('lightbulb', 'w-12 h-12 text-amber-500')}</div>
                        <h3 class="text-2xl font-bold mb-3">福壽螺</h3>
                        <p class="text-stone-600 mb-6 flex-grow">參與我們精心設計的低刺激在地體驗，學習與貓咪的正確互動之道，共創美好回憶。</p>
                        <a href="#" data-page="experience" class="nav-link btn-secondary w-full">預約在地體驗</a>
                    </div>
                `;

                // Render KPI Overview
                const kpi = db.kpiSnapshot;
                const kpiItems = [
                    { title: '送養率', value: `${(kpi.adoptionRate * 100).toFixed(1)}%`, icon: 'heart-handshake' },
                    { title: '平均等待天數', value: `${kpi.avgWaitDays.toFixed(0)} 天`, icon: 'clock' },
                    { title: '準時回報率', value: `${(kpi.onTimeReportRate * 100).toFixed(1)}%`, icon: 'calendar-check' },
                    { title: '內容:銷售比', value: `${kpi.contentToSalesRatio.toFixed(1)} : 1`, icon: 'file-text' },
                ];
                 document.getElementById('kpi-overview-container').innerHTML = `
                    <div class="card p-8">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                            ${kpiItems.map(item => `
                                <div>
                                    <div class="text-orange-500 w-12 h-12 mx-auto mb-2 flex items-center justify-center">${createIcon(item.icon)}</div>
                                    <div class="text-3xl font-bold">${item.value}</div>
                                    <div class="text-stone-500">${item.title}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-8 text-center">
                            <a href="#" data-page="transparency" class="nav-link btn-primary inline-flex items-center">
                                ${createIcon('bar-chart-3', 'mr-2 h-4 w-4')} 查看完整透明儀表板
                            </a>
                        </div>
                    </div>`;

                // Render Latest Posts
                const postsContainer = document.getElementById('latest-posts-container');
                postsContainer.innerHTML = db.contentPosts.map(post => {
                    const categoryMap = {
                      STORY: { name: '貓咪故事', color: 'bg-sky-100 text-sky-800' },
                      EDUCATION: { name: '教育知識', color: 'bg-amber-100 text-amber-800' },
                      TRANSPARENCY: { name: '透明報告', color: 'bg-teal-100 text-teal-800' },
                    };
                    const catDetails = categoryMap[post.category];
                    return `
                        <a href="#" class="card overflow-hidden block group">
                            <div class="p-6">
                                <div class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium mb-3 ${catDetails.color}">${catDetails.name}</div>
                                <h3 class="text-xl font-bold mb-2 group-hover:text-orange-600 transition-colors">${post.title}</h3>
                                <p class="text-stone-600 text-sm mb-4">${post.short}</p>
                            </div>
                        </a>`;
                }).join('');
            }
            
            function renderCatsPage() {
                const container = document.getElementById('cats-list-container');
                container.innerHTML = db.cats.map(createCatCard).join('');
            }
            
            function renderCatProfilePage(catId) {
                const cat = getCatWithStress(catId);
                if (!cat) { navigateTo('cats'); return; }

                const container = document.getElementById('page-cat-profile');
                const latestStress = cat.stressLogs[0];
                const adoptedBadge = cat.status === 'ADOPTED' ? `<div class="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">${createIcon('badge-check', 'w-4 h-4')} 已送養</div>` : '';
                
                const imprintHistory = db.imprintSessions.filter(s => s.catId === cat.id).map(session => `
                    <li class="p-4 bg-stone-50 rounded-lg flex items-center justify-between">
                        <div>
                            <p class="font-bold">追溯碼: <span class="font-mono text-orange-600">${session.traceId}</span></p>
                            <p class="text-sm text-stone-500">
                                ${new Date(session.startedAt).toLocaleString('zh-TW')}
                                <span class="ml-2 px-2 py-0.5 rounded-full text-xs ${session.allowed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">歷時 ${session.durationSeconds} 秒</span>
                            </p>
                        </div>
                    </li>
                `).join('');

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="grid md:grid-cols-3 gap-8">
                            <div class="md:col-span-1">
                                <div class="relative aspect-square w-full rounded-3xl overflow-hidden shadow-lg">
                                    <img src="${cat.coverImage}" alt="" class="w-full h-full object-cover"/>
                                    ${adoptedBadge}
                                </div>
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                <div class="flex justify-between items-start">
                                    <div><h1 class="text-4xl font-bold">${cat.name}</h1><p class="text-stone-500">#${cat.code}</p></div>
                                    ${createStressChip(latestStress?.level, true)}
                                </div>
                                <p class="text-lg text-stone-700 bg-stone-100/80 p-4 rounded-xl">${cat.story}</p>
                                <div class="flex gap-4">
                                    <a href="#" data-page="subscribe" class="nav-link btn-primary w-full text-center">遠端領養 ${cat.name}</a>
                                    <a href="#" data-page="experience" class="nav-link btn-secondary w-full text-center">預約探訪</a>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-12 p-6">
                            <h2 class="text-2xl font-bold mb-4 flex items-center">${createIcon('calendar-days')} 近期壓力趨勢</h2>
                            <div id="chart-container" class="h-60"></div>
                        </div>

                        <div class="card mt-8 p-6">
                            <h2 class="text-2xl font-bold mb-4 flex items-center">${createIcon('paw-print')} 印記取樣紀錄</h2>
                            <ul class="space-y-4">${imprintHistory || '<p class="text-stone-500 text-center py-4">尚無紀錄。</p>'}</ul>
                        </div>
                    </div>`;

                // Render chart
                const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;
                const chartData = cat.stressLogs.map(log => ({
                    date: new Date(log.createdAt).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }),
                    level: log.level === 'G' ? 1 : log.level === 'Y' ? 2 : 3,
                })).reverse();

                const chart = React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                    React.createElement(LineChart, { data: chartData, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                        React.createElement(CartesianGrid, { strokeDasharray: "3 3" }),
                        React.createElement(XAxis, { dataKey: "date" }),
                        React.createElement(YAxis, { domain: [0, 4], ticks: [1, 2, 3], tickFormatter: (v) => ['G', 'Y', 'R'][v - 1] }),
                        React.createElement(Tooltip),
                        React.createElement(Line, { type: "monotone", dataKey: "level", stroke: "#f97316", strokeWidth: 2 })
                    )
                );
                ReactDOM.render(chart, document.getElementById('chart-container'));
            }

            function renderImprintStationPage() {
                const container = document.getElementById('page-imprints-new');
                 if (appState.currentUserRole === 'USER') {
                    container.innerHTML = `<div class="text-center py-20 card">您沒有權限訪問此頁面。<br/>請使用上方的角色切換器，切換為「志工」或「管理者」。</div>`;
                    return;
                }

                const catList = db.cats.filter(c => c.status !== 'ADOPTED').map(cat => {
                    const latestStress = getCatWithStress(cat.id).stressLogs[0];
                    return `<button data-cat-id="${cat.id}" class="imprint-cat-select w-full text-left p-3 rounded-lg flex justify-between items-center hover:bg-stone-100">
                        <span>${cat.name}</span>
                        ${createStressChip(latestStress?.level)}
                    </button>`;
                }).join('');

                container.innerHTML = `
                    <h1 class="page-title">取樣工作站</h1>
                    <p class="page-subtitle">請遵守「零強迫、零傷害」最高原則。所有操作皆會被記錄。</p>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="md:col-span-1"><div class="card p-4 space-y-2">${catList}</div></div>
                        <div class="md:col-span-2">
                            <div id="imprint-action-panel" class="card p-8 min-h-[24rem] flex flex-col justify-center items-center text-center">
                                <!-- Action panel content here -->
                            </div>
                        </div>
                    </div>`;
                renderImprintActionPanel(null);
            }
            
            function renderImprintActionPanel(catId) {
                const panel = document.getElementById('imprint-action-panel');
                if (!catId) {
                    panel.innerHTML = `<p class="text-stone-500">請從左側列表選擇一隻貓咪開始作業。</p>`;
                    return;
                }
                const cat = getCatWithStress(catId);
                const latestStress = cat.stressLogs[0];
                const isEligible = latestStress?.level === 'G';
                
                panel.innerHTML = `
                    <div class="space-y-6">
                        <h3 class="text-3xl font-bold">準備為 ${cat.name} 取樣</h3>
                        <div class="flex flex-col items-center">
                            <p class="mb-2">目前壓力等級：</p>
                            ${createStressChip(latestStress?.level, true)}
                        </div>
                        ${!isEligible ? `
                            <div class="bg-amber-100 text-amber-800 p-4 rounded-lg flex items-center gap-4">
                                ${createIcon('alert-triangle')}
                                <div><p class="font-bold">不符合即時取樣條件</p><p class="text-sm">僅能在貓咪狀態為 G (良好) 時進行。</p></div>
                            </div>
                        ` : `
                            <div class="bg-green-100 text-green-800 p-4 rounded-lg flex items-center gap-4">
                                ${createIcon('shield-check')}
                                <div><p class="font-bold">符合即時取樣條件</p><p class="text-sm">請在 10 秒內完成輕觸取樣。</p></div>
                            </div>
                        `}
                        <button id="start-imprint-btn" class="btn-primary w-full py-3 text-lg" ${!isEligible ? 'disabled' : ''}>
                           ${createIcon('paw-print', 'inline mr-2')} 開始 10 秒計時取樣
                        </button>
                    </div>`;
            }
            
            function renderImprintTimer(cat) {
                 const panel = document.getElementById('imprint-action-panel');
                 let timeLeft = 10;
                 panel.innerHTML = `
                    <div class="flex flex-col items-center justify-center space-y-6">
                        <h2 class="text-2xl font-bold flex items-center">${createIcon('timer')} 取樣進行中...</h2>
                        <div class="relative w-48 h-48">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-stone-200" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/>
                                <circle id="timer-progress" class="text-orange-500" stroke-width="10" stroke-dasharray="283" stroke-dashoffset="0" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: center;"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center"><span id="timer-text" class="text-5xl font-bold">${timeLeft}</span></div>
                        </div>
                    </div>`;

                const timerText = document.getElementById('timer-text');
                const timerProgress = document.getElementById('timer-progress');

                const intervalId = setInterval(() => {
                    timeLeft--;
                    timerText.textContent = timeLeft;
                    const percentage = (timeLeft / 10) * 100;
                    timerProgress.style.strokeDashoffset = 283 - (283 * percentage) / 100;

                    if (timeLeft <= 0) {
                        clearInterval(intervalId);
                        // Simulate success
                        const newSession = { id: Date.now(), catId: cat.id, startedAt: new Date().toISOString(), durationSeconds: 10, allowed: true, method: 'LIVE', traceId: `IMP-${Date.now()}-${cat.id}` };
                        db.imprintSessions.push(newSession);
                        panel.innerHTML = `
                            <div class="space-y-4">
                                <h3 class="text-2xl font-bold text-green-600">取樣成功！</h3>
                                <p>已為 ${cat.name} 建立紀錄。</p>
                                <p class="font-bold">追溯碼: <span class="font-mono bg-stone-100 text-orange-600 p-2 rounded">${newSession.traceId}</span></p>
                                <button id="imprint-done-btn" class="btn-primary">完成</button>
                            </div>`;
                    }
                }, 1000);
            }
            
            function renderBlindboxPage() {
                const container = document.getElementById('page-blindbox');
                const rule = db.blindboxRules[0];
                const ratios = rule.ratios;
                const ratioList = Object.entries(ratios).map(([code, ratio]) => {
                    const cat = db.cats.find(c => c.code === code);
                    return `<li class="flex justify-between p-2 bg-stone-100/80 rounded-md"><span>${cat?.name || code}</span><span class="font-bold">${(ratio * 100).toFixed(0)}%</span></li>`;
                }).join('');

                const stoppedList = db.blindboxStops.map(stop => {
                    const cat = db.cats.find(c => c.id === stop.catId);
                    return `<li class="p-3 flex items-center justify-between"><div><span class="font-bold text-lg">${cat.name}</span><span class="text-sm text-stone-500 ml-4">已於 ${new Date(stop.stoppedAt).toLocaleDateString('zh-TW')} 找到永遠的家！</span></div><a href="#" data-page="cat-profile" data-cat-id="${cat.id}" class="cat-card-link btn-secondary text-sm">回顧故事</a></li>`;
                }).join('');
                
                container.innerHTML = `
                    <div class="space-y-12 max-w-4xl mx-auto">
                        <div><h1 class="page-title">盲盒專區</h1><p class="page-subtitle">我們承諾公開所有盲盒資訊。</p></div>
                        <div class="card p-8">
                            <h2 class="text-2xl font-bold mb-2">2025 Q3 貓掌印記盲盒</h2>
                            <div class="grid md:grid-cols-2 gap-6 mt-6">
                                <div><h3 class="font-bold flex items-center mb-2">${createIcon('percent')} 本季機率公告</h3><ul class="space-y-2">${ratioList}</ul></div>
                                <div><h3 class="font-bold flex items-center mb-2">${createIcon('info')} 規則說明</h3><div class="text-sm text-stone-600 space-y-2 p-3 bg-stone-100/80 rounded-md"><p>▸ <span class="font-semibold">送養即停產：</span>貓咪成功送養後，相關款式立即停產。</p><p>▸ <span class="font-semibold">追溯序號：</span>每件商品均附獨一無二的追溯序號。</p></div></div>
                            </div>
                        </div>
                        <div><h2 class="text-2xl font-bold mb-4 flex items-center">${createIcon('ban')} 停產紀念清單</h2><div class="card p-4"><ul class="divide-y">${stoppedList}</ul></div></div>
                    </div>`;
            }

            function renderSubscribePage() {
                const container = document.getElementById('page-subscribe');
                const plans = db.subscriptionPlans.map((plan, index) => `
                    <div class="card p-8 flex flex-col ${index === 1 ? 'border-orange-400 border-2 relative' : ''}">
                        ${index === 1 ? `<span class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-orange-400 text-white px-3 py-1 text-sm font-bold rounded-full">最受歡迎</span>` : ''}
                        <h2 class="text-2xl font-bold">${plan.name}</h2>
                        <p class="text-4xl font-bold my-4">NT$ ${plan.priceTwd}<span class="text-base font-normal text-stone-500"> / 月</span></p>
                        <ul class="text-left space-y-3 text-stone-600 mt-4 mb-8 flex-grow">
                            <li class="flex items-start gap-2">${createIcon('check-circle-2', 'text-green-500 mt-1 flex-shrink-0')} 每 ${plan.cadenceDays} 天收到一次報告。</li>
                            <li class="flex items-start gap-2">${createIcon('check-circle-2', 'text-green-500 mt-1 flex-shrink-0')} 含飲食醫療摘要與行為筆記。</li>
                        </ul>
                        <a href="#" data-page="cats" class="nav-link ${index === 1 ? 'btn-primary' : 'btn-secondary'} w-full">選擇貓咪並訂閱</a>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto text-center">
                        <h1 class="page-title">遠端領養</h1>
                        <p class="page-subtitle">您的穩定支持，是貓咪們在找到家之前最溫暖的依靠。</p>
                        <div class="grid md:grid-cols-3 gap-8 mt-12">${plans}</div>
                    </div>`;
            }
            
            function renderExperiencePage() {
                const container = document.getElementById('page-experience');
                const slots = db.experienceSlots.map(slot => {
                    const remaining = slot.capacity - slot.bookedCount;
                    const isFull = remaining <= 0;
                    return `
                        <div class="card p-6 flex flex-col md:flex-row items-center gap-6">
                            <div class="flex-grow w-full">
                                <div class="flex items-center gap-4 mb-2">
                                    <span class="bg-orange-100 text-orange-800 font-bold px-3 py-1 rounded-full">${{TPE:'台北',TXG:'台中',KHH:'高雄'}[slot.siteCode]}場</span>
                                    <div class="text-stone-600">${new Date(slot.date).toLocaleDateString('zh-TW')} ${slot.startTime}</div>
                                </div>
                                <div class="mt-4 flex gap-x-6 text-sm text-stone-500">
                                    <span>${createIcon('users', 'inline mr-1')} ${remaining}/${slot.capacity} 位名額</span>
                                    ${slot.vetOnSite ? `<span class="text-teal-600">${createIcon('stethoscope', 'inline mr-1')} 獸醫在場</span>` : ''}
                                </div>
                            </div>
                            <button class="w-full md:w-auto flex-shrink-0 ${isFull ? 'btn-secondary' : 'btn-primary'}" ${isFull ? 'disabled' : ''}>${isFull ? '名額已滿' : '立即預約'}</button>
                        </div>`;
                }).join('');

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <h1 class="page-title text-center">福壽螺・在地體驗</h1>
                        <p class="page-subtitle text-center">預約一場小規模、低刺激的實體互動。</p>
                        <div class="space-y-6 mt-12">${slots}</div>
                    </div>`;
            }
            
            function renderTransparencyPage() {
                const container = document.getElementById('page-transparency');
                const kpi = db.kpiSnapshot;
                const kpiData = [
                    { title: '送養率', value: `${(kpi.adoptionRate * 100).toFixed(1)}%`, icon: 'heart-handshake' },
                    { title: '平均等待天數', value: `${kpi.avgWaitDays.toFixed(0)} 天`, icon: 'clock' },
                    { title: '準時回報率', value: `${(kpi.onTimeReportRate * 100).toFixed(1)}%`, icon: 'calendar-check' },
                    { title: '內容:銷售比', value: `${kpi.contentToSalesRatio.toFixed(1)} : 1`, icon: 'file-text' },
                    { title: '醫療支出覆蓋率', value: `${(kpi.medicalCoverageRate * 100).toFixed(1)}%`, icon: 'heart-pulse' },
                    { title: '壓力紅燈場次', value: kpi.overworkRedSessions, icon: 'alert-triangle' },
                ];
                const receipts = db.receipts.map(r => `
                    <tr class="border-b last:border-none">
                        <td class="p-2">${new Date(r.date).toLocaleDateString('zh-TW')}</td>
                        <td class="p-2">${r.kind}</td><td class="p-2 text-right">${r.amountTwd.toLocaleString()}</td>
                        <td class="p-2">${r.vendor}</td><td class="p-2 font-mono text-xs truncate" title="${r.hash}">${r.hash.substring(0, 32)}...</td>
                    </tr>`).join('');

                container.innerHTML = `
                    <div class="space-y-12">
                        <div><h1 class="page-title">透明儀表板</h1><p class="page-subtitle">所有營運數據公開透明，是我們不變的承諾。</p></div>
                        <section>
                            <h2 class="text-2xl font-bold mb-4">關鍵績效指標 (KPI)</h2>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                ${kpiData.map(item => `<div class="card p-4"><div class="flex justify-between items-start text-stone-500"><h3 class="font-semibold">${item.title}</h3>${createIcon(item.icon)}</div><p class="text-3xl font-bold mt-2">${item.value}</p></div>`).join('')}
                            </div>
                        </section>
                        <section>
                            <h2 class="text-2xl font-bold mb-4">近期收支憑證雜湊</h2>
                            <div class="card p-4 overflow-x-auto"><table class="w-full text-left"><thead class="text-sm text-stone-500 border-b"><tr><th class="p-2">日期</th><th class="p-2">類別</th><th class="p-2">金額</th><th class="p-2">廠商</th><th class="p-2">憑證雜湊</th></tr></thead><tbody>${receipts}</tbody></table></div>
                        </section>
                    </div>`;
            }

            // =================================================================
            // 5. NAVIGATION AND STATE MANAGEMENT
            // =================================================================
            function navigateTo(pageId, data = null) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.add('active');
                    appState.currentPage = pageId;
                    window.scrollTo(0, 0);

                    // Page-specific render logic
                    if (pageId === 'home') renderHomePage();
                    if (pageId === 'cats') renderCatsPage();
                    if (pageId === 'cat-profile' && data && data.catId) {
                        appState.selectedCatId = data.catId;
                        renderCatProfilePage(data.catId);
                    }
                    if (pageId === 'imprints-new') renderImprintStationPage();
                    if (pageId === 'blindbox') renderBlindboxPage();
                    if (pageId === 'subscribe') renderSubscribePage();
                    if (pageId === 'experience') renderExperiencePage();
                    if (pageId === 'transparency') renderTransparencyPage();
                }
            }

            function renderAuthSection() {
                const container = document.getElementById('auth-section');
                const roleMap = { USER: '訪客', VOLUNTEER: '志工', ADMIN: '管理者' };
                container.innerHTML = `
                     <div class="flex items-center gap-2">
                        <span class="text-sm">角色:</span>
                        <select id="role-switcher" class="text-sm bg-stone-100 border-stone-300 rounded-md p-1">
                            <option value="USER" ${appState.currentUserRole === 'USER' ? 'selected' : ''}>訪客</option>
                            <option value="VOLUNTEER" ${appState.currentUserRole === 'VOLUNTEER' ? 'selected' : ''}>志工</option>
                            <option value="ADMIN" ${appState.currentUserRole === 'ADMIN' ? 'selected' : ''}>管理者</option>
                        </select>
                     </div>
                     <a href="#" data-page="imprints-new" id="workstation-link" class="nav-link btn-secondary py-1 px-3 text-sm ${appState.currentUserRole === 'USER' ? 'hidden' : ''}">工作站</a>
                `;
            }
            
            function handleRoleChange(newRole) {
                appState.currentUserRole = newRole;
                renderAuthSection();
                // Re-render current page if it has role-based UI
                if (appState.currentPage === 'imprints-new') {
                    renderImprintStationPage();
                }
            }

            // =================================================================
            // 6. EVENT LISTENERS
            // =================================================================
            document.body.addEventListener('click', (e) => {
                // Nav links
                const navLink = e.target.closest('.nav-link');
                if (navLink) {
                    e.preventDefault();
                    navigateTo(navLink.dataset.page);
                }
                // Cat card links
                const catCardLink = e.target.closest('.cat-card-link');
                if (catCardLink) {
                    e.preventDefault();
                    const catId = parseInt(catCardLink.dataset.catId);
                    navigateTo('cat-profile', { catId });
                }
                // Select cat for imprint
                const imprintCatSelect = e.target.closest('.imprint-cat-select');
                if (imprintCatSelect) {
                    const catId = parseInt(imprintCatSelect.dataset.catId);
                    appState.selectedCatId = catId;
                    renderImprintActionPanel(catId);
                }
                // Start imprint timer
                if (e.target.id === 'start-imprint-btn') {
                    const cat = getCatWithStress(appState.selectedCatId);
                    renderImprintTimer(cat);
                }
                // Imprint done
                if (e.target.id === 'imprint-done-btn') {
                    renderImprintActionPanel(null);
                }
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'role-switcher') {
                    handleRoleChange(e.target.value);
                }
            });

            // =================================================================
            // 7. INITIALIZATION
            // =================================================================
            function init() {
                document.getElementById('footer-year').textContent = new Date().getFullYear();
                renderAuthSection();
                navigateTo('home');
            }

            init();
        });
    </script>
</body>
</html>
